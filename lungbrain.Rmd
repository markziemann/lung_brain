---
title: "Lung-brain axis"
author: "Mark Ziemann"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    fig_width: 7
    fig_height: 7
theme: cosmo
---

Source: https://github.com/markziemann/lungbrain


# Introduction

Eslam’s Summary of RNA seq

* Project title: Characterization any gene expression changes in the mice brain in response to peripheral 
inflammation in the lung (asthma).

* Methodology: Mice were divided into three groups (1 control group and 2 asthmatic groups OVA and LPS).
At the end of the experiment, RNA was isolated from 5 different mice brain regions 
(Hypothalamus, Amygdala, Hippocampus, PAG, and NI) (n=7 per group) using 
(Qiagen RNAeasy Mini kit 250) (Cat# 74106, Hilden, Germany).
In total 104 RNA samples. Afterward, RNA quality control was checked using Qubit4 and 4200 Tapestation.
Then RNA sequencing was done using NEBNext® Ultra™ II Directional RNA Library Prep Kit for Illumina.

* Data form: FASTQ raw data (FYI, RNA-seq reads table is attached in a separate page).

* ID: (1-104)

* Aim: Detection of the differences in gene expression for each brain region between our 3 different groups?


## Bioinformatics methods

Fastqc (v0.11.9) was used to inspect sequence quality[1].

The mouse transcriptome was downloaded from GENCODE version 28[2].

Skewer (v0.2.2) was used to trim low quality bases (qual<20) from the 3' end of the read[3].

Kallisto (0.46.1) was used to map RNA-seq reads to the transcriptome [4].

Multiqc was used to tabulate sequence quality, trimming and mapping statistics [5].

Data were read into R v4.1.2 and duplicate lane data were aggregated, and transcript level counts were aggregated to gene level counts.

Genes with an average of less than 10 reads across samples were excluded from downstream analysis.

DESeq (1.32.0) was used with default settings to assay differential expression between control and treatment groups for all tissues [6].

Pathway analysis was performed with reactome gene sets obtained from MSigDB and converted to mouse gene identifiers with the msigdbr package
(performed on 16-02-2022) [7,8,9].

Differential pathway analysis was performed with the "mitch" bioconductor package [10].

Genes and pathways with false discovery rate (FDR)<0.05 were considered significant.

```{r,packages}

suppressPackageStartupMessages({
    library("zoo")
#    library("tidyverse")
    library("reshape2")
    library("DESeq2")
    library("gplots")
    library("fgsea")
    library("MASS")
    library("mitch")
    library("eulerr")
    library("limma")
    library("topconfects")
    library("kableExtra")
    library("vioplot")
    library("pkgload")
    library("beeswarm")
})

```

## Import read counts

Importing RNA-seq data

```{r,importdata}

#tmp <- read.table("3col.tsv.gz",header=F)
#x <- as.matrix(acast(tmp, V2~V1, value.var="V3", fun.aggregate = sum))
#x <- as.data.frame(x)
#accession <- sapply((strsplit(rownames(x),"\\|")),"[[",2)
#symbol<-sapply((strsplit(rownames(x),"\\|")),"[[",6)
#x$geneid <- paste(accession,symbol)
#xx <- aggregate(. ~ geneid,x,sum)
#rownames(xx) <- xx$geneid
#xx$geneid = NULL
#xx <- round(xx)
#xx <- xx[,which(colnames(xx)!="test")]
#xx[1:6,1:6]
#dim(xx)
xx <- read.table("lungbrain_counts.tsv",sep="\t")

```

Fix the sample names.

They are duplicated for lane 1 and 2, which I will aggregate.

```{r,colnames}

#txx <- as.data.frame(t(xx))
#txx$label <- sapply(strsplit(rownames(txx),"_"),"[[",1)
#txx[1:3,c(1:4,ncol(txx))]
#txx2 <- aggregate(. ~ label,txx,sum)
#txx2[1:3,1:4]
#rownames(txx2) <- txx2[,1]
#txx2[,1] = NULL
#xx <- as.data.frame(t(txx2))
#xx[1:4,1:5]
##write.table(xx,file="lungbrain_counts.tsv",sep="\t",quote=FALSE)
rxx <- apply(xx,2,function(x) { x / sum(x) * 1e6  } )
rxx[1:4,1:5]
head(colSums(rxx))

```

Samplesheet.

Need to delete "EA13-4".

```{r,ss}

ss <- read.table("lungbrain_samplesheet.tsv",header=TRUE)

rownames(ss) <- paste("EA",as.character(ss$OriginalID),sep="")
ss <- ss[order(rownames(ss)),]

rownames(ss) == colnames(rxx)

ss %>% kbl(caption = "Sample sheet") %>%
  kable_paper("hover", full_width = F)

```

## QC analysis

Here I'll look at a few different quality control measures.

The simplest is the number and proportion of reads that are assigned to genes.

```{r,qc1,fig.height=7,fig.width=7}

par(mar=c(5,8,3,1))
barplot(colSums(xx),horiz=TRUE,las=1,xlab="num reads",col=ss$cols)
sums <- colSums(xx)
sums <- sums[order(sums)]
barplot(sums,horiz=TRUE,las=1,xlab="num reads",cex.names=0.8)
abline(v=15000000,col="red")
which(sums<15000000)

barplot(head(sums,6),horiz=TRUE,las=1,xlab="num reads",cex.names=1)
abline(v=15000000,col="red")
which(sums<15000000)

pdf("plot01_qc01.pdf")
par(mar=c(5,8,3,1))
barplot(colSums(xx),horiz=TRUE,las=1,xlab="num reads",col=ss$cols)
sums <- colSums(xx)
sums <- sums[order(sums)]
barplot(sums,horiz=TRUE,las=1,xlab="num reads",cex.names=0.8)
abline(v=15000000,col="red")
which(sums<15000000)

barplot(head(sums,6),horiz=TRUE,las=1,xlab="num reads",cex.names=1)
abline(v=15000000,col="red")
which(sums<15000000)
dev.off()

```

Now to look at the rRNA content.

```{r,rrna}

rrna <- read.table("https://raw.githubusercontent.com/markziemann/lung_brain/main/rrna_res.tsv")
myrrna <- rrna$V2/10000
names(myrrna) <- rrna$V1
myrrna <- myrrna[order(myrrna)]

barplot(myrrna,horiz=TRUE,las=1,xlab="percent rRNA reads",cex.names=0.8)
abline(v=10,col="red")

barplot(tail(myrrna),horiz=TRUE,las=1,xlab="percent rRNA reads",cex.names=0.8)
abline(v=10,col="red")

pdf("plot02_rrna01.pdf")
barplot(myrrna,horiz=TRUE,las=1,xlab="percent rRNA reads",cex.names=0.8)
abline(v=10,col="red")

barplot(tail(myrrna),horiz=TRUE,las=1,xlab="percent rRNA reads",cex.names=0.8)
abline(v=10,col="red")
dev.off()

myrrna[which(myrrna>10)]

```

## MDS plot for all samples

Multidimensional scaling plot to show the variation between all samples, very similar to PCA.

```{r,mds1,fig.height=7,fig.width=7}

par(mar=c(5.1,4.1,4.1,2.1))

mds <- cmdscale(dist(t(xx)))

cols <- as.numeric(as.factor(ss$Region))+1
pchs <- as.numeric(factor(ss$Treatment))+14

plot(mds, xlab="Coordinate 1", ylab="Coordinate 2",
  type = "p",bty="n",pch=pchs, cex=4 ,col=cols )
text(mds, labels=rownames(mds) ,col="black")

legend("bottomleft", inset=.02, title="tissue",
   legend=unique(as.factor(ss$Region)) , fill=unique(cols),  cex=1.2)

legend("left", inset=.02, title="treatment",
   legend=unique(as.factor(ss$Treatment)) , pch=unique(pchs),  cex=1.2)


pdf("plot03_mds01.pdf")
plot(mds, xlab="Coordinate 1", ylab="Coordinate 2",
  type = "p",bty="n",pch=pchs, cex=4 ,col=cols )
text(mds, labels=rownames(mds) ,col="black")
legend("bottomleft", inset=.02, title="tissue",
   legend=unique(as.factor(ss$Region)) , fill=unique(cols),  cex=1.2)
legend("left", inset=.02, title="treatment",
   legend=unique(as.factor(ss$Treatment)) , pch=unique(pchs),  cex=1.2)
dev.off()

```

## Correlation heatmap

```{r,correl1}

heatmap.2(cor(xx),trace="n",main="Pearson correlation heatmap",margin=c(8,8),cexRow=0.7,cexCol=0.7)

heatmap.2(cor(xx),trace="n",main="Pearson correlation heatmap",margin=c(8,8),cexRow=0.7,cexCol=0.7)

pdf("plot04_cor01.pdf")
heatmap.2(cor(xx),trace="n",main="Pearson correlation heatmap",margin=c(8,8),cexRow=0.7,cexCol=0.7)
heatmap.2(cor(xx),trace="n",main="Pearson correlation heatmap",margin=c(8,8),cexRow=0.7,cexCol=0.7)
dev.off()

```

## Set up the different datasets for differential expression analysis

Here, I'll give an example on how to separate the data matrix by tissue and then evaluate differential expression.

Don't forget to remove poorly detected genes from the matrix with a threshold of 10 reads per sample on average.

There are 5 contrasts to set up, one for each tissue.

The separate sample sheets are called s1, s2, etc.

The separate counts tables are called x1, x2, etc.

I will begin with hypothalamus and leave the rest to Craig's team.

```{r,filter}

# hyp 1
ss1 <- ss[which(ss$Region=="hyp"),]
xx1 <- xx[which(colnames(xx) %in% rownames(ss1))]
xx1 <- xx1[which(rowMeans(xx1)>=10),]
rpm1 <- apply(xx1,2,function(x) { x / sum(x) * 1e6  } )
ss1_l <- ss[which(ss$Region=="hyp" & ss$Treatment != "OVA"),]
xx1_l <- xx[which(colnames(xx) %in% rownames(ss1_l))]
xx1_l <- xx1_l[which(rowMeans(xx1_l)>=10),]
rpm1_l <- apply(xx1_l,2,function(x) { x / sum(x) * 1e6  } )
ss1_o <- ss[which(ss$Region=="hyp" & ss$Treatment != "LPS"),]
xx1_o <- xx[which(colnames(xx) %in% rownames(ss1_o))]
xx1_o <- xx1_o[which(rowMeans(xx1_o)>=10),]
rpm1_o <- apply(xx1_o,2,function(x) { x / sum(x) * 1e6  } )

# amy 2
ss2 <- ss[which(ss$Region=="amy"),]
xx2 <- xx[which(colnames(xx) %in% rownames(ss2))]
xx2 <- xx2[which(rowMeans(xx2)>=10),]
rpm2 <- apply(xx2,2,function(x) { x / sum(x) * 1e6  } )
ss2_l <- ss[which(ss$Region=="amy" & ss$Treatment != "OVA"),]
xx2_l <- xx[which(colnames(xx) %in% rownames(ss2_l))]
xx2_l <- xx2_l[which(rowMeans(xx2_l)>=10),]
rpm2_l <- apply(xx2_l,2,function(x) { x / sum(x) * 1e6  } )
ss2_o <- ss[which(ss$Region=="amy" & ss$Treatment != "LPS"),]
xx2_o <- xx[which(colnames(xx) %in% rownames(ss2_o))]
xx2_o <- xx2_o[which(rowMeans(xx2_o)>=10),]
rpm2_o <- apply(xx2_o,2,function(x) { x / sum(x) * 1e6  } )

# hip 3
ss3 <- ss[which(ss$Region=="hip"),]
xx3 <- xx[which(colnames(xx) %in% rownames(ss3))]
xx3 <- xx3[which(rowMeans(xx3)>=10),]
rpm3 <- apply(xx3,2,function(x) { x / sum(x) * 1e6  } )
ss3_l <- ss[which(ss$Region=="hip" & ss$Treatment != "OVA"),]
xx3_l <- xx[which(colnames(xx) %in% rownames(ss3_l))]
xx3_l <- xx3_l[which(rowMeans(xx3_l)>=10),]
rpm3_l <- apply(xx3_l,2,function(x) { x / sum(x) * 1e6  } )
ss3_o <- ss[which(ss$Region=="hip" & ss$Treatment != "LPS"),]
xx3_o <- xx[which(colnames(xx) %in% rownames(ss3_o))]
xx3_o <- xx3_o[which(rowMeans(xx3_o)>=10),]
rpm3_o <- apply(xx3_o,2,function(x) { x / sum(x) * 1e6  } )

# pag 4
ss4 <- ss[which(ss$Region=="pag"),]
xx4 <- xx[which(colnames(xx) %in% rownames(ss4))]
xx4 <- xx4[which(rowMeans(xx4)>=10),]
rpm4 <- apply(xx4,2,function(x) { x / sum(x) * 1e6  } )
ss4_l <- ss[which(ss$Region=="pag" & ss$Treatment != "OVA"),]
xx4_l <- xx[which(colnames(xx) %in% rownames(ss4_l))]
xx4_l <- xx4_l[which(rowMeans(xx4_l)>=10),]
rpm4_l <- apply(xx4_l,2,function(x) { x / sum(x) * 1e6  } )
ss4_o <- ss[which(ss$Region=="pag" & ss$Treatment != "LPS"),]
xx4_o <- xx[which(colnames(xx) %in% rownames(ss4_o))]
xx4_o <- xx4_o[which(rowMeans(xx4_o)>=10),]
rpm4_o <- apply(xx4_o,2,function(x) { x / sum(x) * 1e6  } )

# ni 5
ss5 <- ss[which(ss$Region=="NI"),]
xx5 <- xx[which(colnames(xx) %in% rownames(ss5))]
xx5 <- xx5[which(rowMeans(xx5)>=10),]
rpm5 <- apply(xx5,2,function(x) { x / sum(x) * 1e6  } )
ss5_l <- ss[which(ss$Region=="NI" & ss$Treatment != "OVA"),]
xx5_l <- xx[which(colnames(xx) %in% rownames(ss5_l))]
xx5_l <- xx5_l[which(rowMeans(xx5_l)>=10),]
rpm5_l <- apply(xx5,2,function(x) { x / sum(x) * 1e6  } )
ss5_o <- ss[which(ss$Region=="NI" & ss$Treatment != "LPS"),]
xx5_o <- xx[which(colnames(xx) %in% rownames(ss5_o))]
xx5_o <- xx5_o[which(rowMeans(xx5_o)>=10),]
rpm5 <- apply(xx5,2,function(x) { x / sum(x) * 1e6  } )

message("dimensions of objects: n genes, n samples")
l <- list("xx"=xx,"xx1"=xx1,"xx1 l"= xx1_l,"xx1 o"=xx1_o,
  "xx2"=xx2,"xx2 l"=xx2_l,"xx2 o"=xx2_o,
  "xx3"=xx3,"xx3 l"=xx3_l,"xx3 o"=xx3_o,
  "xx4"=xx4,"xx4 l"=xx4_l,"xx4 o"=xx5_o,
  "xx5"=xx5,"xx5 l"=xx5_l,"xx5 o"=xx5_o)

lapply(l,dim)

```

```{r,mds2}

par(mar=c(5.1,4.1,4.1,2.1))

# hyp 1
mds <- cmdscale(dist(t(xx1)))
cols <- as.numeric(factor(ss1$Treatment))+1

plot(mds, xlab="Coordinate 1", ylab="Coordinate 2",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "hyp")
text(mds, labels=rownames(mds) ,col="black")

legend("bottomleft", inset=.02, title="treatment",
   legend=unique(as.factor(ss$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

pdf("plot05_mds02.pdf")
plot(mds, xlab="Coordinate 1", ylab="Coordinate 2",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "hyp")
text(mds, labels=rownames(mds) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
   legend=unique(as.factor(ss$Treatment)) , pch=19,col=unique(cols),  cex=1.2)
dev.off()

# Sample 3.1à has high rRNA content
# Sample 9.1à no problem in its QC but will look for other explanation
rpm1m <- rowMeans(rpm1)
de1_inv <- data.frame(rpm1[,"EA9.1"] , rpm1m )
colnames(de1_inv) <- c("ea9.1","mean")
de1_inv$ratio <- de1_inv$ea9.1 / de1_inv$mean
de1_inv <- de1_inv[order(-de1_inv$ratio),]
head(de1_inv,20)

```

Remove 3.1 as it has high rRNA content.
Sample 9.1 appears as possible outlier, but no obvious reason to exclude it from the analysis.
EG no problem with QC and no gene expression profile features that indicate tissue contamination.

Then repeat the MDS.

```{r,mds2b}

ss1 <- ss1[rownames(ss1)!="EA3.1",]
xx1 <- xx1[,colnames(xx1) %in% rownames(ss1)]

# hyp 1
mds <- cmdscale(dist(t(xx1)),k=4)
cols <- as.numeric(factor(ss1$Treatment))+1

# 1 vs 2
plot(mds, xlab="Coordinate 1", ylab="Coordinate 2",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "hyp")
text(mds, labels=rownames(mds) ,col="black")

legend("bottomleft", inset=.02, title="treatment",
  legend=unique(as.factor(ss1$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 1 vs 3
plot(mds[,c(1,3)], xlab="Coordinate 1", ylab="Coordinate 3",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "hyp")
text(mds[,c(1,3)], labels=rownames(mds[,c(1,3)]) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
   legend=unique(as.factor(ss1$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 2 vs 3
plot(mds[,c(2,3)], xlab="Coordinate 2", ylab="Coordinate 3",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "hyp")
text(mds[,c(2,3)], labels=rownames(mds[,c(2,3)]) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
  legend=unique(as.factor(ss1$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 1 vs 4
plot(mds[,c(1,4)], xlab="Coordinate 1", ylab="Coordinate 4",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "hyp")
text(mds[,c(1,4)], labels=rownames(mds[,c(1,4)]) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
  legend=unique(as.factor(ss1$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 2 vs 4
plot(mds[,c(2,4)], xlab="Coordinate 2", ylab="Coordinate 4",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "hyp")
text(mds[,c(2,4)], labels=rownames(mds[,c(2,4)]) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
  legend=unique(as.factor(ss1$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 3 vs 4
plot(mds[,c(3,4)], xlab="Coordinate 3", ylab="Coordinate 4",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "hyp")
text(mds[,c(3,4)], labels=rownames(mds[,c(3,4)]) ,col="black")
legend("topright", inset=.02, title="treatment",
  legend=unique(as.factor(ss1$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

pdf("plot06_mds03.pdf")
plot(mds, xlab="Coordinate 1", ylab="Coordinate 2",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "hyp")
text(mds, labels=rownames(mds) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
   legend=unique(as.factor(ss1$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 1 vs 3
plot(mds[,c(1,3)], xlab="Coordinate 1", ylab="Coordinate 3",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "hyp")
text(mds[,c(1,3)], labels=rownames(mds[,c(1,3)]) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
   legend=unique(as.factor(ss1$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 2 vs 3
plot(mds[,c(2,3)], xlab="Coordinate 2", ylab="Coordinate 3",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "hyp")
text(mds[,c(2,3)], labels=rownames(mds[,c(2,3)]) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
  legend=unique(as.factor(ss1$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 1 vs 4
plot(mds[,c(1,4)], xlab="Coordinate 1", ylab="Coordinate 4",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "hyp")
text(mds[,c(1,4)], labels=rownames(mds[,c(1,4)]) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
  legend=unique(as.factor(ss1$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 2 vs 4
plot(mds[,c(2,4)], xlab="Coordinate 2", ylab="Coordinate 4",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "hyp")
text(mds[,c(2,4)], labels=rownames(mds[,c(2,4)]) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
  legend=unique(as.factor(ss1$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 3 vs 4
plot(mds[,c(3,4)], xlab="Coordinate 3", ylab="Coordinate 4",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "hyp")
text(mds[,c(3,4)], labels=rownames(mds[,c(3,4)]) ,col="black")
legend("topright", inset=.02, title="treatment",
  legend=unique(as.factor(ss1$Treatment)) , pch=19,col=unique(cols),  cex=1.2)
dev.off()

```

```{r,mds3}

# amy 2
mds <- cmdscale(dist(t(xx2)),k=4)
cols <- as.numeric(factor(ss2$Treatment))+1

# 1 vs 2
plot(mds, xlab="Coordinate 1", ylab="Coordinate 2",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "amy")
text(mds, labels=rownames(mds) ,col="black")

legend("bottomleft", inset=.02, title="treatment",
  legend=unique(as.factor(ss2$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 1 vs 3
plot(mds[,c(1,3)], xlab="Coordinate 1", ylab="Coordinate 3",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "amy")
text(mds[,c(1,3)], labels=rownames(mds[,c(1,3)]) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
   legend=unique(as.factor(ss2$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 2 vs 3
plot(mds[,c(2,3)], xlab="Coordinate 2", ylab="Coordinate 3",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "amy")
text(mds[,c(2,3)], labels=rownames(mds[,c(2,3)]) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
  legend=unique(as.factor(ss2$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 1 vs 4
plot(mds[,c(1,4)], xlab="Coordinate 1", ylab="Coordinate 4",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "amy")
text(mds[,c(1,4)], labels=rownames(mds[,c(1,4)]) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
  legend=unique(as.factor(ss2$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 2 vs 4
plot(mds[,c(2,4)], xlab="Coordinate 2", ylab="Coordinate 4",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "amy")
text(mds[,c(2,4)], labels=rownames(mds[,c(2,4)]) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
  legend=unique(as.factor(ss2$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 3 vs 4
plot(mds[,c(3,4)], xlab="Coordinate 3", ylab="Coordinate 4",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "amy")
text(mds[,c(3,4)], labels=rownames(mds[,c(3,4)]) ,col="black")
legend("topright", inset=.02, title="treatment",
  legend=unique(as.factor(ss2$Treatment)) , pch=19,col=unique(cols),  cex=1.2)


pdf("plot07_mds04.pdf")

plot(mds, xlab="Coordinate 1", ylab="Coordinate 2",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "amy")
text(mds, labels=rownames(mds) ,col="black")

legend("bottomleft", inset=.02, title="treatment",
  legend=unique(as.factor(ss2$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 1 vs 3
plot(mds[,c(1,3)], xlab="Coordinate 1", ylab="Coordinate 3",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "amy")
text(mds[,c(1,3)], labels=rownames(mds[,c(1,3)]) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
   legend=unique(as.factor(ss2$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 2 vs 3
plot(mds[,c(2,3)], xlab="Coordinate 2", ylab="Coordinate 3",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "amy")
text(mds[,c(2,3)], labels=rownames(mds[,c(2,3)]) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
  legend=unique(as.factor(ss2$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 1 vs 4
plot(mds[,c(1,4)], xlab="Coordinate 1", ylab="Coordinate 4",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "amy")
text(mds[,c(1,4)], labels=rownames(mds[,c(1,4)]) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
  legend=unique(as.factor(ss2$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 2 vs 4
plot(mds[,c(2,4)], xlab="Coordinate 2", ylab="Coordinate 4",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "amy")
text(mds[,c(2,4)], labels=rownames(mds[,c(2,4)]) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
  legend=unique(as.factor(ss2$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 3 vs 4
plot(mds[,c(3,4)], xlab="Coordinate 3", ylab="Coordinate 4",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "amy")
text(mds[,c(3,4)], labels=rownames(mds[,c(3,4)]) ,col="black")
legend("topright", inset=.02, title="treatment",
  legend=unique(as.factor(ss2$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

dev.off()

# hip 3
mds <- cmdscale(dist(t(xx3)),k=4)
cols <- as.numeric(factor(ss3$Treatment))+1

# 1 vs 2
plot(mds, xlab="Coordinate 1", ylab="Coordinate 2",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "hip")
text(mds, labels=rownames(mds) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
  legend=unique(as.factor(ss3$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 1 vs 3
plot(mds[,c(1,3)], xlab="Coordinate 1", ylab="Coordinate 3",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "hip")
text(mds[,c(1,3)], labels=rownames(mds[,c(1,3)]) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
   legend=unique(as.factor(ss3$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 2 vs 3
plot(mds[,c(2,3)], xlab="Coordinate 2", ylab="Coordinate 3",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "hip")
text(mds[,c(2,3)], labels=rownames(mds[,c(2,3)]) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
  legend=unique(as.factor(ss3$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 1 vs 4
plot(mds[,c(1,4)], xlab="Coordinate 1", ylab="Coordinate 4",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "hip")
text(mds[,c(1,4)], labels=rownames(mds[,c(1,4)]) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
  legend=unique(as.factor(ss3$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 2 vs 4
plot(mds[,c(2,4)], xlab="Coordinate 2", ylab="Coordinate 4",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "hip")
text(mds[,c(2,4)], labels=rownames(mds[,c(2,4)]) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
  legend=unique(as.factor(ss3$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 3 vs 4
plot(mds[,c(3,4)], xlab="Coordinate 3", ylab="Coordinate 4",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "hip")
text(mds[,c(3,4)], labels=rownames(mds[,c(3,4)]) ,col="black")
legend("topright", inset=.02, title="treatment",
  legend=unique(as.factor(ss3$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

pdf("plot08_mds05.pdf")

# 1 vs 2
plot(mds, xlab="Coordinate 1", ylab="Coordinate 2",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "hip")
text(mds, labels=rownames(mds) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
  legend=unique(as.factor(ss3$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 1 vs 3
plot(mds[,c(1,3)], xlab="Coordinate 1", ylab="Coordinate 3",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "hip")
text(mds[,c(1,3)], labels=rownames(mds[,c(1,3)]) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
   legend=unique(as.factor(ss3$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 2 vs 3
plot(mds[,c(2,3)], xlab="Coordinate 2", ylab="Coordinate 3",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "hip")
text(mds[,c(2,3)], labels=rownames(mds[,c(2,3)]) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
  legend=unique(as.factor(ss3$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 1 vs 4
plot(mds[,c(1,4)], xlab="Coordinate 1", ylab="Coordinate 4",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "hip")
text(mds[,c(1,4)], labels=rownames(mds[,c(1,4)]) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
  legend=unique(as.factor(ss3$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 2 vs 4
plot(mds[,c(2,4)], xlab="Coordinate 2", ylab="Coordinate 4",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "hip")
text(mds[,c(2,4)], labels=rownames(mds[,c(2,4)]) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
  legend=unique(as.factor(ss3$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

# 3 vs 4
plot(mds[,c(3,4)], xlab="Coordinate 3", ylab="Coordinate 4",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "hip")
text(mds[,c(3,4)], labels=rownames(mds[,c(3,4)]) ,col="black")
legend("topright", inset=.02, title="treatment",
  legend=unique(as.factor(ss3$Treatment)) , pch=19,col=unique(cols),  cex=1.2)


dev.off()

# pag 4
mds <- cmdscale(dist(t(xx4)))
cols <- as.numeric(factor(ss4$Treatment))+1

plot(mds, xlab="Coordinate 1", ylab="Coordinate 2",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "pag")
text(mds, labels=rownames(mds) ,col="black")

legend("bottomleft", inset=.02, title="treatment",
   legend=unique(as.factor(ss$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

pdf("plot09_mds06.pdf")
plot(mds, xlab="Coordinate 1", ylab="Coordinate 2",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "pag")
text(mds, labels=rownames(mds) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
   legend=unique(as.factor(ss$Treatment)) , pch=19,col=unique(cols),  cex=1.2)
dev.off()

# ni 5
mds <- cmdscale(dist(t(xx5)))
cols <- as.numeric(factor(ss5$Treatment))+1

plot(mds, xlab="Coordinate 1", ylab="Coordinate 2",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "ni")
text(mds, labels=rownames(mds) ,col="black")

legend("bottomleft", inset=.02, title="treatment",
   legend=unique(as.factor(ss$Treatment)) , pch=19,col=unique(cols),  cex=1.2)

pdf("plot10_mds07.pdf")
plot(mds, xlab="Coordinate 1", ylab="Coordinate 2",
  type = "p",bty="n",pch=19, cex=4 ,col=cols , main = "ni")
text(mds, labels=rownames(mds) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
   legend=unique(as.factor(ss$Treatment)) , pch=19,col=unique(cols),  cex=1.2)
dev.off()

```


## Differential expression with DESeq2

For each brain region, there are two treatments, and so two contrasts are performed.

Before we do that, let's look at the MDS plot of the hypothalamus data.

```{r,mds_hyp}

par(mar=c(5.1,4.1,4.1,2.1))

mds <- cmdscale(dist(t(xx1)))

cols <- as.numeric(factor(ss1$Treatment))+1

plot(mds, xlab="Coordinate 1", ylab="Coordinate 2",
  type = "p",bty="n", pch=19, cex=4 ,col=cols )
text(mds, labels=rownames(mds) ,col="black")

legend("bottomleft", inset=.02, title="treatment",
   legend=unique(as.factor(ss1$Treatment)) , col=unique(cols), pch=19,  cex=1.2)

pdf("plot11_mds08.pdf")
plot(mds, xlab="Coordinate 1", ylab="Coordinate 2",
  type = "p",bty="n", pch=19, cex=4 ,col=cols )
text(mds, labels=rownames(mds) ,col="black")
legend("bottomleft", inset=.02, title="treatment",
   legend=unique(as.factor(ss1$Treatment)) , col=unique(cols), pch=19,  cex=1.2)
dev.off()

```

Now run DESeq2 for all contrasts.

```{r,de01}

# 1 hyp
dds <- DESeqDataSetFromMatrix(countData = xx1_l , colData = ss1_l , design = ~ Treatment )
res <- DESeq(dds)
z <- results(res)
vsd <- vst(dds, blind=FALSE)
zz <- cbind(as.data.frame(z),assay(vsd))
dge <- as.data.frame(zz[order(zz$pvalue),])
dge1_l <- dge
d1up_l <- rownames(subset(dge1_l,padj <= 0.05 & log2FoldChange > 0))
d1dn_l <- rownames(subset(dge1_l,padj <= 0.05 & log2FoldChange < 0))
write.table(dge1_l,file="dge1_l.tsv",quote=FALSE,sep="\t")

dds <- DESeqDataSetFromMatrix(countData = xx1_o , colData = ss1_o , design = ~ Treatment )
res <- DESeq(dds)
z <- results(res)
vsd <- vst(dds, blind=FALSE)
zz <- cbind(as.data.frame(z),assay(vsd))
dge <- as.data.frame(zz[order(zz$pvalue),])
dge1_o <- dge
d1up_o <- rownames(subset(dge1_o,padj <= 0.05 & log2FoldChange > 0))
d1dn_o <- rownames(subset(dge1_o,padj <= 0.05 & log2FoldChange < 0))
write.table(dge1_o,file="dge1_o.tsv",quote=FALSE,sep="\t")

# 2 amy
dds <- DESeqDataSetFromMatrix(countData = xx2_l , colData = ss2_l , design = ~ Treatment )
res <- DESeq(dds)
z <- results(res)
vsd <- vst(dds, blind=FALSE)
zz <- cbind(as.data.frame(z),assay(vsd))
dge <- as.data.frame(zz[order(zz$pvalue),])
dge2_l <- dge
d2up_l <- rownames(subset(dge2_l,padj <= 0.05 & log2FoldChange > 0))
d2dn_l <- rownames(subset(dge2_l,padj <= 0.05 & log2FoldChange < 0))
write.table(dge2_l,file="dge2_l.tsv",quote=FALSE,sep="\t")

dds <- DESeqDataSetFromMatrix(countData = xx2_o , colData = ss2_o , design = ~ Treatment )
res <- DESeq(dds)
z <- results(res)
vsd <- vst(dds, blind=FALSE)
zz <- cbind(as.data.frame(z),assay(vsd))
dge <- as.data.frame(zz[order(zz$pvalue),])
dge2_o <- dge
d2up_o <- rownames(subset(dge2_o,padj <= 0.05 & log2FoldChange > 0))
d2dn_o <- rownames(subset(dge2_o,padj <= 0.05 & log2FoldChange < 0))
write.table(dge2_o,file="dge2_o.tsv",quote=FALSE,sep="\t")

# 3 hip
dds <- DESeqDataSetFromMatrix(countData = xx3_l , colData = ss3_l , design = ~ Treatment )
res <- DESeq(dds)
z <- results(res)
vsd <- vst(dds, blind=FALSE)
zz <- cbind(as.data.frame(z),assay(vsd))
dge <- as.data.frame(zz[order(zz$pvalue),])
dge3_l <- dge
d3up_l <- rownames(subset(dge3_l,padj <= 0.05 & log2FoldChange > 0))
d3dn_l <- rownames(subset(dge3_l,padj <= 0.05 & log2FoldChange < 0))
write.table(dge3_l,file="dge3_l.tsv",quote=FALSE,sep="\t")

dds <- DESeqDataSetFromMatrix(countData = xx3_o , colData = ss3_o , design = ~ Treatment )
res <- DESeq(dds)
z <- results(res)
vsd <- vst(dds, blind=FALSE)
zz <- cbind(as.data.frame(z),assay(vsd))
dge <- as.data.frame(zz[order(zz$pvalue),])
dge3_o <- dge
d3up_o <- rownames(subset(dge3_o,padj <= 0.05 & log2FoldChange > 0))
d3dn_o <- rownames(subset(dge3_o,padj <= 0.05 & log2FoldChange < 0))
write.table(dge3_o,file="dge3_o.tsv",quote=FALSE,sep="\t")

# 4 pag
dds <- DESeqDataSetFromMatrix(countData = xx4_l , colData = ss4_l , design = ~ Treatment )
res <- DESeq(dds)
z <- results(res)
vsd <- vst(dds, blind=FALSE)
zz <- cbind(as.data.frame(z),assay(vsd))
dge <- as.data.frame(zz[order(zz$pvalue),])
dge4_l <- dge
d4up_l <- rownames(subset(dge4_l,padj <= 0.05 & log2FoldChange > 0))
d4dn_l <- rownames(subset(dge4_l,padj <= 0.05 & log2FoldChange < 0))
write.table(dge4_l,file="dge4_l.tsv",quote=FALSE,sep="\t")

dds <- DESeqDataSetFromMatrix(countData = xx4_o , colData = ss4_o , design = ~ Treatment )
res <- DESeq(dds)
z <- results(res)
vsd <- vst(dds, blind=FALSE)
zz <- cbind(as.data.frame(z),assay(vsd))
dge <- as.data.frame(zz[order(zz$pvalue),])
dge4_o <- dge
d4up_o <- rownames(subset(dge4_o,padj <= 0.05 & log2FoldChange > 0))
d4dn_o <- rownames(subset(dge4_o,padj <= 0.05 & log2FoldChange < 0))
write.table(dge4_o,file="dge4_o.tsv",quote=FALSE,sep="\t")

# 5 NI
dds <- DESeqDataSetFromMatrix(countData = xx5_l , colData = ss5_l , design = ~ Treatment )
res <- DESeq(dds)
z <- results(res)
vsd <- vst(dds, blind=FALSE)
zz <- cbind(as.data.frame(z),assay(vsd))
dge <- as.data.frame(zz[order(zz$pvalue),])
dge5_l <- dge
d5up_l <- rownames(subset(dge5_l,padj <= 0.05 & log2FoldChange > 0))
d5dn_l <- rownames(subset(dge5_l,padj <= 0.05 & log2FoldChange < 0))
write.table(dge5_l,file="dge5_l.tsv",quote=FALSE,sep="\t")

dds <- DESeqDataSetFromMatrix(countData = xx5_o , colData = ss5_o , design = ~ Treatment )
res <- DESeq(dds)
z <- results(res)
vsd <- vst(dds, blind=FALSE)
zz <- cbind(as.data.frame(z),assay(vsd))
dge <- as.data.frame(zz[order(zz$pvalue),])
dge5_o <- dge
d5up_o <- rownames(subset(dge5_o,padj <= 0.05 & log2FoldChange > 0))
d5dn_o <- rownames(subset(dge5_o,padj <= 0.05 & log2FoldChange < 0))
write.table(dge5_o,file="dge5_o.tsv",quote=FALSE,sep="\t")

```

Here let's look at some plots.

MA plot shows the average level and fold change of all detected genes.
Volcano plot shows the fold change and the significance, as measured by -log(p-value).
Significant genes are shown as red points.

There are heatmaps of the top ranked genes by p-value.
Above the gene expression values there is a bar in orange/gray colours.
Control is shown in orange and treatment in grey.

```{r,deplot_func}

maplot <- function(de,contrast_name) {
  de <- de[which(!is.na(de$padj)),]
  sig <-subset(de, padj < 0.05 )
  up <-rownames(subset(de, padj < 0.05 & log2FoldChange > 0))
  dn <-rownames(subset(de, padj < 0.05 & log2FoldChange < 0))
  GENESUP <- length(up)
  GENESDN <- length(dn)
  DET=nrow(de)
  SUBHEADER = paste(GENESUP, "up, ", GENESDN, "down", DET, "detected")
  ns <-subset(de, padj > 0.05 )
  plot(log2(de$baseMean),de$log2FoldChange,
       xlab="log2 basemean", ylab="log2 foldchange",
       pch=19, cex=0.5, col="dark gray",
       main=contrast_name, cex.main=1)
  points(log2(sig$baseMean),sig$log2FoldChange,
         pch=19, cex=0.5, col="red")
  mtext(SUBHEADER,cex = 1)
}

make_volcano_old <- function(de,name) {
    de <- de[which(!is.na(de$padj)),]
    de$pvalue[which(de$pvalue==0)] <- 1e-320
    sig <- subset(de,padj<0.05)
    N_SIG=nrow(sig)
    N_UP=nrow(subset(sig,log2FoldChange>0))
    N_DN=nrow(subset(sig,log2FoldChange<0))
    DET=nrow(de)
    HEADER=paste( DET, "detected,", N_SIG,"@5%FDR:", N_DN, "dn", N_UP, "up")
    plot(de$log2FoldChange,-log10(de$pval),cex=0.5,pch=19,col="darkgray",
        main=name, xlab="log2 FC", ylab="-log10 pval")
    mtext(HEADER)
    grid()
    points(sig$log2FoldChange,-log10(sig$pval),cex=0.5,pch=19,col="red")
}

make_volcano <- function(de,name) {
    de <- de[which(!is.na(de$padj)),]
    de$pvalue[which(de$pvalue==0)] <- 1e-320
    sig <- subset(de,padj<0.05)
    # get 5% FDR thresh
    myp = tail(sig,1)$pvalue
    myfdr = tail(sig,1)$padj
    fdrthresh = -log10(myp / myfdr * 0.05)
    N_SIG=nrow(sig)
    N_UP=nrow(subset(sig,log2FoldChange>0))
    N_DN=nrow(subset(sig,log2FoldChange<0))
    DET=nrow(de)
    HEADER=paste( DET, "detected,", N_SIG,"@5%FDR:", N_DN, "dn", N_UP, "up")
    plot(de$log2FoldChange,-log10(de$pval),cex=0.5,pch=19,col="darkgray",
        main=name, xlab="log2 FC", ylab="-log10 pval")
    mtext(HEADER)
    abline(h=fdrthresh,col="red",lty=2)
    abline(v=0,col="black",lty=2)
    grid()
    points(sig$log2FoldChange,-log10(sig$pval),cex=0.5,pch=19,col="red")
}

make_heatmap <- function(de,name,myss,mx,n=30){
  colfunc <- colorRampPalette(c("blue", "white", "red"))
  csc <- myss$Treatment
  csc <- gsub("Control","orange",csc)
  csc <- gsub("LPS","gray",csc)
  csc <- gsub("OVA","yellow",csc)
  mxn <- mx/rowSums(mx)*1000000
  x <- mxn[which(rownames(mxn) %in% rownames(head(de,n))),]
  heatmap.2(as.matrix(x),trace="none",col=colfunc(25),scale="row", margins = c(10,15), cexRow=0.7,
    main=paste("Top ranked",n,"genes in",name) , ColSideColors = csc  )
  mtext("ctrl=orange, LPS=gray, OVA=yellow")
}

make_heatmap2 <- function(de,name,myss,mx,n=30){
  colfunc <- colorRampPalette(c("blue", "white", "red"))
  csc <- myss$Treatment
  csc <- gsub("Control","orange",csc)
  csc <- gsub("LPS","gray",csc)
  csc <- gsub("OVA","yellow",csc)
  mxn <- mx/rowSums(mx)*1000000
  x <- mxn[which(rownames(mxn) %in% rownames(head(de,n))),]
  rownames(x) <- sapply(strsplit(rownames(x)," "),"[[",2)
  heatmap.2(as.matrix(x),trace="none",col=colfunc(25),scale="row", margins = c(10,15), cexRow=0.7,
    main=paste("Top ranked",n,"genes in",name) ,  ColSideColors = csc   )
  mtext("ctrl=orange, LPS=gray, OVA=yellow")
}

mymds <- function(de,name,myss,mx) {
  mds <- cmdscale(dist(t(mx)))
  csc <-  myss$Treatment
  csc <- gsub("Control","orange",csc)
  csc <- gsub("LPS","gray",csc)
  csc <- gsub("OVA","yellow",csc)
  plot(mds, xlab="Coordinate 1", ylab="Coordinate 2", main = name ,
    type = "p",bty="n",pch=19, cex=4 ,col=csc )
  text(mds, labels=rownames(mds) ,col="black")
  legend("topright", inset=.02, title="treatment",
    legend=unique(as.factor(myss$Treatment)) , pch=19, col=unique(csc),  cex=1.4)
}

```

## Results for hypothalamus

We show an MDS plot, MA plot, volcano plot, heatmap and table of top results for each contrast.

```{r,deres1}

mymds(de=dge1_l,name="Cont1: Effect of LPS treatment in hypothalamus",myss=ss1_l,mx=xx1_l)
maplot(dge1_l,"Cont1: Effect of LPS treatment in hypothalamus")
make_volcano(dge1_l,"Cont1: Effect of LPS treatment in hypothalamus")
make_heatmap(de=dge1_l,name="Cont1: Effect of LPS treatment in hypothalamus",myss=ss1_l,mx=xx1_l,n=50)
make_heatmap2(de=dge1_l,name="Cont1: Effect of LPS treatment in hypothalamus",myss=ss1_l,mx=xx1_l,n=50)
dge1_l[1:20,1:6] %>% kbl(caption = "Top gene expression differences for contrast 1: Effect of LPS treatment in hypothalamus") %>%
  kable_paper("hover", full_width = F)

mymds(de=dge1_o,name="Cont1: Effect of OVA treatment in hypothalamus",myss=ss1_o,mx=xx1_o)
maplot(dge1_o,"Cont1: Effect of OVA treatment in hypothalamus")
make_volcano(dge1_o,"Cont1: Effect of OVA treatment in hypothalamus")
make_heatmap(de=dge1_o,name="Cont1: Effect of OVA treatment in hypothalamus",myss=ss1_o,mx=xx1_o,n=50)
make_heatmap2(de=dge1_o,name="Cont1: Effect of OVA treatment in hypothalamus",myss=ss1_o,mx=xx1_o,n=50)
dge1_o[1:20,1:6] %>% kbl(caption = "Top gene expression differences for contrast 1: Effect of treatment in hypothalamus") %>%
  kable_paper("hover", full_width = F)

pdf("plot12_de01.pdf")
mymds(de=dge1_l,name="Cont1: Effect of LPS treatment in hypothalamus",myss=ss1_l,mx=xx1_l)
maplot(dge1_l,"Cont1: Effect of LPS treatment in hypothalamus")
make_volcano(dge1_l,"Cont1: Effect of LPS treatment in hypothalamus")
make_heatmap(de=dge1_l,name="Cont1: Effect of LPS treatment in hypothalamus",myss=ss1_l,mx=xx1_l,n=50)
make_heatmap2(de=dge1_l,name="Cont1: Effect of LPS treatment in hypothalamus",myss=ss1_l,mx=xx1_l,n=50)
mymds(de=dge1_o,name="Cont1: Effect of OVA treatment in hypothalamus",myss=ss1_o,mx=xx1_o)
maplot(dge1_o,"Cont1: Effect of OVA treatment in hypothalamus")
make_volcano(dge1_o,"Cont1: Effect of OVA treatment in hypothalamus")
make_heatmap(de=dge1_o,name="Cont1: Effect of OVA treatment in hypothalamus",myss=ss1_o,mx=xx1_o,n=50)
make_heatmap2(de=dge1_o,name="Cont1: Effect of OVA treatment in hypothalamus",myss=ss1_o,mx=xx1_o,n=50)
dev.off()

```

## Results for amygdala

```{r,deres2}

mymds(de=dge2_l,name="Cont2: Effect of LPS treatment in amygdala",myss=ss2_l,mx=xx2_l)
maplot(dge2_l,"Cont2: Effect of LPS treatment in amygdala")
make_volcano(dge2_l,"Cont2: Effect of LPS treatment in amygdala")
make_heatmap(de=dge2_l,name="Cont2: Effect of LPS treatment in amygdala",myss=ss2_l,mx=xx2_l,n=50)
make_heatmap2(de=dge2_l,name="Cont2: Effect of LPS treatment in amygdala",myss=ss2_l,mx=xx2_l,n=50)
dge2_l[1:20,1:6] %>% kbl(caption = "Top gene expression differences for contrast 2: Effect of LPS treatment in amygdala") %>%
  kable_paper("hover", full_width = F)

mymds(de=dge2_o,name="Cont2: Effect of OVA treatment in amygdala",myss=ss2_o,mx=xx2_o)
maplot(dge2_o,"Cont2: Effect of OVA treatment in amygdala")
make_volcano(dge2_o,"Cont2: Effect of OVA treatment in amygdala")
make_heatmap(de=dge2_o,name="Cont2: Effect of OVA treatment in amygdala",myss=ss2_o,mx=xx2_o,n=50)
make_heatmap2(de=dge2_o,name="Cont2: Effect of OVA treatment in amygdala",myss=ss2_o,mx=xx2_o,n=50)
dge2_o[1:20,1:6] %>% kbl(caption = "Top gene expression differences for contrast 2: Effect of treatment in amygdala") %>%
  kable_paper("hover", full_width = F)

pdf("plot13_de02.pdf")
mymds(de=dge2_l,name="Cont2: Effect of LPS treatment in amygdala",myss=ss2_l,mx=xx2_l)
maplot(dge2_l,"Cont2: Effect of LPS treatment in amygdala")
make_volcano(dge2_l,"Cont2: Effect of LPS treatment in amygdala")
make_heatmap(de=dge2_l,name="Cont2: Effect of LPS treatment in amygdala",myss=ss2_l,mx=xx2_l,n=50)
make_heatmap2(de=dge2_l,name="Cont2: Effect of LPS treatment in amygdala",myss=ss2_l,mx=xx2_l,n=50)
mymds(de=dge2_o,name="Cont2: Effect of OVA treatment in amygdala",myss=ss2_o,mx=xx2_o)
maplot(dge2_o,"Cont2: Effect of OVA treatment in amygdala")
make_volcano(dge2_o,"Cont2: Effect of OVA treatment in amygdala")
make_heatmap(de=dge2_o,name="Cont2: Effect of OVA treatment in amygdala",myss=ss2_o,mx=xx2_o,n=50)
make_heatmap2(de=dge2_o,name="Cont2: Effect of OVA treatment in amygdala",myss=ss2_o,mx=xx2_o,n=50)
dev.off()
```

## Results for hippocampus

```{r,deres3}

mymds(de=dge3_l,name="Cont3: Effect of LPS treatment in hippocampus",myss=ss3_l,mx=xx3_l)
maplot(dge3_l,"Cont3: Effect of LPS treatment in hippocampus")
make_volcano(dge3_l,"Cont3: Effect of LPS treatment in hippocampus")
make_heatmap(de=dge3_l,name="Cont3: Effect of LPS treatment in hippocampus",myss=ss3_l,mx=xx3_l,n=50)
make_heatmap2(de=dge3_l,name="Cont3: Effect of LPS treatment in hippocampus",myss=ss3_l,mx=xx3_l,n=50)
dge3_l[1:20,1:6] %>% kbl(caption = "Top gene expression differences for contrast 3: Effect of LPS treatment in hippocampus") %>%
  kable_paper("hover", full_width = F)

mymds(de=dge3_o,name="Cont3: Effect of OVA treatment in hippocampus",myss=ss3_o,mx=xx3_o)
maplot(dge3_o,"Cont3: Effect of OVA treatment in hippocampus")
make_volcano(dge3_o,"Cont3: Effect of OVA treatment in hippocampus")
make_heatmap(de=dge3_o,name="Cont3: Effect of OVA treatment in hippocampus",myss=ss3_o,mx=xx3_o,n=50)
make_heatmap2(de=dge3_o,name="Cont3: Effect of OVA treatment in hippocampus",myss=ss3_o,mx=xx3_o,n=50)
dge3_o[1:20,1:6] %>% kbl(caption = "Top gene expression differences for contrast 3: Effect of treatment in hippocampus") %>%
  kable_paper("hover", full_width = F)

pdf("plot14_de03.pdf")
mymds(de=dge3_l,name="Cont3: Effect of LPS treatment in hippocampus",myss=ss3_l,mx=xx3_l)
maplot(dge3_l,"Cont3: Effect of LPS treatment in hippocampus")
make_volcano(dge3_l,"Cont3: Effect of LPS treatment in hippocampus")
make_heatmap(de=dge3_l,name="Cont3: Effect of LPS treatment in hippocampus",myss=ss3_l,mx=xx3_l,n=50)
make_heatmap2(de=dge3_l,name="Cont3: Effect of LPS treatment in hippocampus",myss=ss3_l,mx=xx3_l,n=50)
mymds(de=dge3_o,name="Cont3: Effect of OVA treatment in hippocampus",myss=ss3_o,mx=xx3_o)
maplot(dge3_o,"Cont3: Effect of OVA treatment in hippocampus")
make_volcano(dge3_o,"Cont3: Effect of OVA treatment in hippocampus")
make_heatmap(de=dge3_o,name="Cont3: Effect of OVA treatment in hippocampus",myss=ss3_o,mx=xx3_o,n=50)
make_heatmap2(de=dge3_o,name="Cont3: Effect of OVA treatment in hippocampus",myss=ss3_o,mx=xx3_o,n=50)
dev.off()

```

## Results for PAG

```{r,deres4}

mymds(de=dge4_l,name="Cont4: Effect of LPS treatment in PAG",myss=ss4_l,mx=xx4_l)
maplot(dge4_l,"Cont4: Effect of LPS treatment in PAG")
make_volcano(dge4_l,"Cont4: Effect of LPS treatment in PAG")
make_heatmap(de=dge4_l,name="Cont4: Effect of LPS treatment in PAG",myss=ss4_l,mx=xx4_l,n=50)
make_heatmap2(de=dge4_l,name="Cont3: Effect of LPS treatment in PAG",myss=ss4_l,mx=xx4_l,n=50)
dge4_l[1:20,1:6] %>% kbl(caption = "Top gene expression differences for contrast 4: Effect of LPS treatment in PAG") %>%
  kable_paper("hover", full_width = F)

mymds(de=dge4_o,name="Cont4: Effect of OVA treatment in PAG",myss=ss4_o,mx=xx4_o)
maplot(dge4_o,"Cont4: Effect of OVA treatment in PAG")
make_volcano(dge4_o,"Cont4: Effect of OVA treatment in PAG")
make_heatmap(de=dge4_o,name="Cont4: Effect of OVA treatment in PAG",myss=ss4_o,mx=xx4_o,n=50)
make_heatmap2(de=dge4_o,name="Cont4: Effect of OVA treatment in PAG",myss=ss4_o,mx=xx4_o,n=50)
dge4_o[1:20,1:6] %>% kbl(caption = "Top gene expression differences for contrast 4: Effect of treatment in PAG") %>%
  kable_paper("hover", full_width = F)

pdf("plot15_de04.pdf")
mymds(de=dge4_l,name="Cont4: Effect of LPS treatment in PAG",myss=ss4_l,mx=xx4_l)
maplot(dge4_l,"Cont4: Effect of LPS treatment in PAG")
make_volcano(dge4_l,"Cont4: Effect of LPS treatment in PAG")
make_heatmap(de=dge4_l,name="Cont4: Effect of LPS treatment in PAG",myss=ss4_l,mx=xx4_l,n=50)
make_heatmap2(de=dge4_l,name="Cont3: Effect of LPS treatment in PAG",myss=ss4_l,mx=xx4_l,n=50)
mymds(de=dge4_o,name="Cont4: Effect of OVA treatment in PAG",myss=ss4_o,mx=xx4_o)
maplot(dge4_o,"Cont4: Effect of OVA treatment in PAG")
make_volcano(dge4_o,"Cont4: Effect of OVA treatment in PAG")
make_heatmap(de=dge4_o,name="Cont4: Effect of OVA treatment in PAG",myss=ss4_o,mx=xx4_o,n=50)
make_heatmap2(de=dge4_o,name="Cont4: Effect of OVA treatment in PAG",myss=ss4_o,mx=xx4_o,n=50)
dev.off()

```

## Results for NI

```{r,deres5}

mymds(de=dge5_l,name="Cont5: Effect of LPS treatment in NI",myss=ss5_l,mx=xx5_l)
maplot(dge5_l,"Cont5: Effect of LPS treatment in NI")
make_volcano(dge5_l,"Cont5: Effect of LPS treatment in NI")
make_heatmap(de=dge5_l,name="Cont5: Effect of LPS treatment in NI",myss=ss5_l,mx=xx5_l,n=50)
make_heatmap2(de=dge5_l,name="Cont3: Effect of LPS treatment in NI",myss=ss5_l,mx=xx5_l,n=50)
dge5_l[1:20,1:6] %>% kbl(caption = "Top gene expression differences for contrast 5: Effect of LPS treatment in NI") %>%
  kable_paper("hover", full_width = F)

mymds(de=dge5_o,name="Cont5: Effect of OVA treatment in NI",myss=ss5_o,mx=xx5_o)
maplot(dge5_o,"Cont4: Effect of OVA treatment in NI")
make_volcano(dge5_o,"Cont5: Effect of OVA treatment in NI")
make_heatmap(de=dge5_o,name="Cont5: Effect of OVA treatment in NI",myss=ss5_o,mx=xx5_o,n=50)
make_heatmap2(de=dge5_o,name="Cont5: Effect of OVA treatment in NI",myss=ss5_o,mx=xx5_o,n=50)
dge5_o[1:20,1:6] %>% kbl(caption = "Top gene expression differences for contrast 5: Effect of treatment in NI") %>%
  kable_paper("hover", full_width = F)

pdf("plot16_de05.pdf")
mymds(de=dge5_l,name="Cont5: Effect of LPS treatment in NI",myss=ss5_l,mx=xx5_l)
maplot(dge5_l,"Cont5: Effect of LPS treatment in NI")
make_volcano(dge5_l,"Cont5: Effect of LPS treatment in NI")
make_heatmap(de=dge5_l,name="Cont5: Effect of LPS treatment in NI",myss=ss5_l,mx=xx5_l,n=50)
make_heatmap2(de=dge5_l,name="Cont3: Effect of LPS treatment in NI",myss=ss5_l,mx=xx5_l,n=50)
mymds(de=dge5_o,name="Cont5: Effect of OVA treatment in NI",myss=ss5_o,mx=xx5_o)
maplot(dge5_o,"Cont4: Effect of OVA treatment in NI")
make_volcano(dge5_o,"Cont5: Effect of OVA treatment in NI")
make_heatmap(de=dge5_o,name="Cont5: Effect of OVA treatment in NI",myss=ss5_o,mx=xx5_o,n=50)
make_heatmap2(de=dge5_o,name="Cont5: Effect of OVA treatment in NI",myss=ss5_o,mx=xx5_o,n=50)
dev.off()

```

## Euler diagrams

Below we're comparing the effect of the two treatments on the number of genes found, using an Euler diagram.

```{r,euler}

par(mar=c(2,2,2,2))

v1 <- list("hyp LPS up"=d1up_l,
  "hyp LPS dn"=d1dn_l,
  "hyp OVA up"=d1up_o,
  "hyp OVA dn"=d1dn_o)
plot(euler(v1),quantities = TRUE, edges = "gray", main="effect of treatments on hyp")

v2 <- list("amy LPS up"=d2up_l,
  "amy LPS dn"=d2dn_l,
  "amy OVA up"=d2up_o,
  "amy OVA dn"=d2dn_o)
plot(euler(v2),quantities = TRUE, edges = "gray", main="effect of treatments on amy")

v3 <- list("hip LPS up"=d3up_l,
  "hip LPS dn"=d3dn_l,
  "hip OVA up"=d3up_o,
  "hip OVA dn"=d3dn_o)
plot(euler(v3),quantities = TRUE, edges = "gray", main="effect of treatments on hip")

v4 <- list("pag LPS up"=d4up_l,
  "pag LPS dn"=d4dn_l,
  "pag OVA up"=d4up_o,
  "pag OVA dn"=d4dn_o)
plot(euler(v4),quantities = TRUE, edges = "gray", main="effect of treatments on pag")

v5 <- list("NI LPS up"=d5up_l,
  "NI LPS dn"=d5dn_l,
  "NI OVA up"=d5up_o,
  "NI OVA dn"=d5dn_o)
plot(euler(v5),quantities = TRUE, edges = "gray", main="effect of treatments on ni")


pdf("plot17_euler01.pdf")
plot(euler(v1),quantities = TRUE, edges = "gray", main="effect of treatments on hyp")
plot(euler(v2),quantities = TRUE, edges = "gray", main="effect of treatments on amy")
plot(euler(v3),quantities = TRUE, edges = "gray", main="effect of treatments on hip")
plot(euler(v4),quantities = TRUE, edges = "gray", main="effect of treatments on pag")
plot(euler(v5),quantities = TRUE, edges = "gray", main="effect of treatments on ni")
dev.off()

```

## Mitch pathway analysis in hyp

Gene sets are obtained from Reactome.

Firstly need to conduct mitch enrichment analysis for each contrast separately.

```{r,gene_sets}

if  (!file.exists("mouse_msigdb_reactome_2022-02-16.gmt")) {
  download.file("http://ziemann-lab.net/public/msigdb_mouse/mouse_msigdb_reactome_2022-02-16.gmt",
    destfile="mouse_msigdb_reactome_2022-02-16.gmt")
}
genesets <- gmt_import("mouse_msigdb_reactome_2022-02-16.gmt")
names(genesets) <- gsub("REACTOME_","",names(genesets))
names(genesets) <- gsub("_"," ",names(genesets))

# gene table
gt <- as.data.frame(rownames(xx))
gt$gene <- sapply(strsplit(gt[,1]," "),"[[",2)

```

Mitch for LPS in hyp

```{r,mitch 1 lps}

m1_l <- mitch_import(dge1_l, DEtype="deseq2",geneTable=gt)
mres1_l <- mitch_calc(m1_l, genesets, priority="effect")
head(mres1_l$enrichment_result,20) %>%
  kbl(caption = "Top gene pathway differences in hypothalamus for LPS") %>%
  kable_paper("hover", full_width = F)
m1_l_top <- subset(mres1_l$enrichment_result,p.adjustANOVA<0.05)
m1_l_up <- subset(m1_l_top,s.dist>0)$set
m1_l_dn <- subset(m1_l_top,s.dist<0)$set
mitch_report(mres1_l,outfile="mitch1_l.html",overwrite=TRUE)
write.table(mres1_l$enrichment_result,file="mitch1_l.tsv",quote=FALSE,sep="\t",row.names=FALSE)

m1_l_top_up <- head(subset(m1_l_top,s.dist>0),10)[,"s.dist"]
names(m1_l_top_up) <- head(subset(m1_l_top,s.dist>0),10)[,"set"]
m1_l_top_dn <- head(subset(m1_l_top,s.dist<0),10)[,"s.dist"]
names(m1_l_top_dn) <- head(subset(m1_l_top,s.dist<0),10)[,"set"]
m1_l_top_updn <- c(m1_l_top_up,m1_l_top_dn)
m1_l_top_updn <- m1_l_top_updn[order(m1_l_top_updn)]

par(mar=c(5,25,3,1))
barplot(m1_l_top_updn,horiz=TRUE,las=1,col="darkgray",
  xlab="Enrichment score",cex.names=0.8,xlim=c(-1,1),
  main="Effect of LPS in hyp")
grid()

pdf("plot18_mitch1lps01.pdf")
par(mar=c(5,25,3,1))
barplot(m1_l_top_updn,horiz=TRUE,las=1,col="darkgray",
  xlab="Enrichment score",cex.names=0.8,xlim=c(-1,1),
  main="Effect of LPS in hyp")
grid()
dev.off()

```

Mitch for OVA in hyp

```{r,mitch 1 ova}

m1_o <- mitch_import(dge1_o, DEtype="deseq2",geneTable=gt)
mres1_o <- mitch_calc(m1_o, genesets, priority="effect")
head(mres1_o$enrichment_result,20) %>%
  kbl(caption = "Top gene pathway differences in hypothalamus for OVA") %>%
  kable_paper("hover", full_width = F)
m1_o_top <- subset(mres1_o$enrichment_result,p.adjustANOVA<0.05)
m1_o_up <- subset(m1_o_top,s.dist>0)$set
m1_o_dn <- subset(m1_o_top,s.dist<0)$set
mitch_report(mres1_o,outfile="mitch1_o.html",overwrite=TRUE)
write.table(mres1_o$enrichment_result,file="mitch1_o.tsv",quote=FALSE,sep="\t",row.names=FALSE)

m1_o_top_up <- head(subset(m1_o_top,s.dist>0),10)[,"s.dist"]
names(m1_o_top_up) <- head(subset(m1_o_top,s.dist>0),10)[,"set"]
m1_o_top_dn <- head(subset(m1_o_top,s.dist<0),10)[,"s.dist"]
names(m1_o_top_dn) <- head(subset(m1_o_top,s.dist<0),10)[,"set"]
m1_o_top_updn <- c(m1_o_top_up,m1_o_top_dn)
m1_o_top_updn <- m1_o_top_updn[order(m1_o_top_updn)]

par(mar=c(5,25,3,1))
barplot(m1_o_top_updn,horiz=TRUE,las=1,col="darkgray",
  xlab="Enrichment score",cex.names=0.8,xlim=c(-1,1),
  main="Effect of LPS in hyp")
grid()

pdf("plot19_mitch1ova01.pdf")
par(mar=c(5,25,3,1))
barplot(m1_o_top_updn,horiz=TRUE,las=1,col="darkgray",
  xlab="Enrichment score",cex.names=0.8,xlim=c(-1,1),
  main="Effect of LPS in hyp")
grid()
dev.off()

```

```{r,mitch 1 euler}

m1_l_up <- subset(m1_l_top,s.dist>0)$set
m1_l_dn <- subset(m1_l_top,s.dist<0)$set
m1_o_up <- subset(m1_o_top,s.dist>0)$set
m1_o_dn <- subset(m1_o_top,s.dist<0)$set

par(mar=c(2,2,2,2))

v0 <- list("LPS up"=m1_l_up,
  "LPS dn"=m1_l_dn,
  "OVA up"=m1_o_up,
  "OVA dn"=m1_o_dn)
plot(euler(v0),quantities = TRUE, edges = "gray", main="effect of treatments on hyp")

pdf("plot20_mitch1lpsovaeuler01.pdf")
plot(euler(v0),quantities = TRUE, edges = "gray", main="effect of treatments on hyp")
dev.off()

```

Two dimensional mitch analysis in hyp.

```{r,mitch1_2d}

ml <- list("LPS"=dge1_l,"OVA"=dge1_o)
m1 <- mitch_import(ml, DEtype="deseq2",geneTable=gt)
head(m1)

mres1 <- mitch_calc(m1, genesets, priority="effect")

head(mres1$enrichment_result,20) %>%
  kbl(caption = "Top gene pathway differences in hypothalamus for LPS and OVA") %>%
  kable_paper("hover", full_width = F)
m1_top <- subset(mres1$enrichment_result,p.adjustMANOVA<0.05)
m1_up <- subset(m1_top,s.dist>0)$set
m1_dn <- subset(m1_top,s.dist<0)$set
mitch_report(mres1,outfile="mitch1.html",overwrite=TRUE)
write.table(mres1$enrichment_result,file="mitch1.tsv",quote=FALSE,sep="\t",row.names=FALSE)

m1_top_up <- head(subset(m1_top,s.dist>0),10)[,"s.dist"]
names(m1_top_up) <- head(subset(m1_top,s.dist>0),10)[,"set"]
m1_top_dn <- head(subset(m1_top,s.dist<0),10)[,"s.dist"]
names(m1_top_dn) <- head(subset(m1_top,s.dist<0),10)[,"set"]
m1_top_updn <- c(m1_top_up,m1_top_dn)
m1_top_updn <- m1_top_updn[order(m1_top_updn)]

```

Need to make a scatterplot to highlight the following:

* Serotonin Neurotransmitter Release Cycle (DN)
* Class C3 metabotropic glutamate pheromone receptors (DN)
* Regulation of commissural axon pathfinding by SLIT AND robo (DN)
* Reduction of Cytosolic Ca (DN)
* YAP1 and WWTR1 TAZ STIMULATED GENE EXPRESSION (UP)
* Activation of the mRNA upon binding (UP)
* Regulation of expression of slits and robs (UP)

```{r,mitch1_scatter}

par(mar=c(4,4,2,1))

a <- mres1$enrichment_result
plot(a$s.LPS , a$s.OVA,pch=19,col="gray")
abline(h=0,lty=2)
abline(v=0,lty=2)
as <- subset(a,p.adjustMANOVA<0.05)
points(as$s.LPS , as$s.OVA,pch=19,col="red")

abline(h=0.2,lty=2,col="red")
abline(v=0.2,lty=2,col="red")
abline(h=-0.2,lty=2,col="red")
abline(v=-0.2,lty=2,col="red")

mysets <- c("SEROTONIN NEUROTRANSMITTER RELEASE CYCLE",
  "CLASS C 3 METABOTROPIC GLUTAMATE PHEROMONE RECEPTORS",
  "REGULATION OF COMMISSURAL AXON PATHFINDING BY SLIT AND ROBO",
  "REDUCTION OF CYTOSOLIC CA LEVELS",
  "YAP1 AND WWTR1 TAZ STIMULATED GENE EXPRESSION",
  "ACTIVATION OF THE MRNA UPON BINDING OF THE CAP BINDING COMPLEX AND EIFS AND SUBSEQUENT BINDING TO 43S",
  "REGULATION OF EXPRESSION OF SLITS AND ROBOS")

a2 <- a[which(a$set %in% mysets),]

points(a2$s.LPS , a2$s.OVA+0.025,pch=25,col="red")

pdf("plot21_mitch1_scatter01.pdf")

a <- mres1$enrichment_result
plot(a$s.LPS , a$s.OVA,pch=19,col="gray")
abline(h=0,lty=2)
abline(v=0,lty=2)
as <- subset(a,p.adjustMANOVA<0.05)
points(as$s.LPS , as$s.OVA,pch=19,col="red")

abline(h=0.2,lty=2,col="red")
abline(v=0.2,lty=2,col="red")
abline(h=-0.2,lty=2,col="red")
abline(v=-0.2,lty=2,col="red")

mysets <- c("SEROTONIN NEUROTRANSMITTER RELEASE CYCLE",
  "CLASS C 3 METABOTROPIC GLUTAMATE PHEROMONE RECEPTORS",
  "REGULATION OF COMMISSURAL AXON PATHFINDING BY SLIT AND ROBO",
  "REDUCTION OF CYTOSOLIC CA LEVELS",
  "YAP1 AND WWTR1 TAZ STIMULATED GENE EXPRESSION",
  "ACTIVATION OF THE MRNA UPON BINDING OF THE CAP BINDING COMPLEX AND EIFS AND SUBSEQUENT BINDING TO 43S",
  "REGULATION OF EXPRESSION OF SLITS AND ROBOS")

a2 <- a[which(a$set %in% mysets),]

points(a2$s.LPS , a2$s.OVA+0.025,pch=25,col="red")

dev.off()

```

```{r,mitch1_tbl}

subset(as,s.LPS>0.2 & s.OVA>0.2)  %>%
  kbl(caption = "Pathways upregulated in LPS and OVA") %>%
  kable_paper("hover", full_width = F)

subset(as,s.LPS<-0.2 & s.OVA<0.2)  %>%
  kbl(caption = "Pathways downregulated in LPS and OVA") %>%
  kable_paper("hover", full_width = F)

# heatmap 30
mr1 <- head(subset(mres1$enrichment_result,p.adjustMANOVA<0.05),30)
mr1 <- as.matrix(mr1[,4:5])
rownames(mr1) <- head(mres1$enrichment_result,30)$set

colfunc <- colorRampPalette(c("blue", "white", "red"))

par(mar=c(2,2,2,2))
heatmap.2(mr1,trace="none",col=colfunc(25),scale="none", margins = c(10,28), cexRow=0.7,
  main="Top ranked pathways in hypothalamus" , cexCol=0.9 )

pdf("plot22_mitch1_heatmap01.pdf")
heatmap.2(mr1,trace="none",col=colfunc(25),scale="none", margins = c(10,28), cexRow=0.7,
  main="Top ranked pathways in hypothalamus" , cexCol=0.9 )
dev.off()

# heatmap 50
mr1 <- head(subset(mres1$enrichment_result,p.adjustMANOVA<0.05),50)
mr1 <- as.matrix(mr1[,4:5])
rownames(mr1) <- head(mres1$enrichment_result,50)$set

colfunc <- colorRampPalette(c("blue", "white", "red"))

par(mar=c(2,2,2,2))
heatmap.2(mr1,trace="none",col=colfunc(25),scale="none", margins = c(10,28), cexRow=0.7,
  main="Top ranked pathways in hypothalamus" , cexCol=0.9 )

pdf("plot22_mitch1_heatmap01b.pdf")
heatmap.2(mr1,trace="none",col=colfunc(25),scale="none", margins = c(10,28), cexRow=0.7,
  main="Top ranked pathways in hypothalamus" , cexCol=0.9 )
dev.off()

```

Two dimensional mitch analysis in hyp with focus on discordant pathways

```{r,mitch1_2d_discord}

mres1 <- mitch_calc(m1, genesets, priority="SD")

head(mres1$enrichment_result,20) %>%
  kbl(caption = "Top gene pathway discordant differences in hypothalamus for LPS and OVA") %>%
  kable_paper("hover", full_width = F)
m1_top <- subset(mres1$enrichment_result,p.adjustMANOVA<0.05)
mitch_report(mres1,outfile="mitch1_discord.html",overwrite=TRUE)
write.table(mres1$enrichment_result,file="mitch1_discord.tsv",quote=FALSE,sep="\t",row.names=FALSE)

m1_top_up <- head(subset(m1_top,s.dist>0),10)[,"s.dist"]
names(m1_top_up) <- head(subset(m1_top,s.dist>0),10)[,"set"]
m1_top_dn <- head(subset(m1_top,s.dist<0),10)[,"s.dist"]
names(m1_top_dn) <- head(subset(m1_top,s.dist<0),10)[,"set"]
m1_top_updn <- c(m1_top_up,m1_top_dn)
m1_top_updn <- m1_top_updn[order(m1_top_updn)]

```

Paper 1 (the hypothalamus, referred as mitch 1 in our analysis):

Thanks for sending the MDS plots and the discordant Mitch1. Criag and I are interested in the following gene sets:
Neuronal System gene sets: directly related to mental health, very interesting) (Appeared in the old original JOINT mitch 1 heatmap), which are:

* Highly calcium permeable postsynaptic nicotinic acetylcholine receptors

* Acetylcholine binding and downstream events

* Serotonin Neurotransmitter Release Cycle

* CREB1 phosphorylation through the activation of Adenylate Cyclase

* Voltage gated Potassium channels

```{r,mitch1_bespokeheat}

mres1 <- mitch_calc(m1, genesets, priority="effect")

## Neuronal sets
mysets2 <- c("HIGHLY CALCIUM PERMEABLE POSTSYNAPTIC NICOTINIC ACETYLCHOLINE RECEPTORS",
"ACETYLCHOLINE BINDING AND DOWNSTREAM EVENTS",
"SEROTONIN NEUROTRANSMITTER RELEASE CYCLE",
"CREB1 PHOSPHORYLATION THROUGH THE ACTIVATION OF ADENYLATE CYCLASE",
"VOLTAGE GATED POTASSIUM CHANNELS")

mres1_bespoke <- mres1$enrichment_result[which(mres1$enrichment_result$set %in% mysets2),]
rownames(mres1_bespoke) <- mres1_bespoke$set

mres1_bespoke %>%
  kbl(caption = "Selected neuronal pathways in hypothalamus for LPS and OVA") %>%
  kable_paper("hover", full_width = F)

mres1mx <- as.matrix(mres1_bespoke[,c("s.LPS","s.OVA")])

heatmap.2(mres1mx,trace="none",col=colfunc(25),scale="none", margins = c(15,28), cexRow=0.7,
  main="Neuronal pathways in hypothalamus" , cexCol=0.9 )

lapply(1:length(mysets2), function(i) {
  myset=mysets2[i]
  mygenes <- genesets[[which(names(genesets) == myset)]]
  allnames <- rownames(rpm1)
  allnames <- sapply(strsplit(allnames," "),"[[",2)
  mymx <- rpm1[which(allnames %in% mygenes),]
  mymx <- mymx[,colnames(mymx) %in% rownames(ss1)] # filter for those present in ss1
  mycols <- gsub("OVA","purple",gsub("LPS","orange",gsub("Control","green",ss1$Treatment)))

  heatmap.2(mymx,trace="none",col=colfunc(25),scale="row", margins = c(10,15), cexRow=0.7,
    ColSideColors=mycols,main=myset)
  mtext("Ctrl=green,LPS=orange,OVA=purple")
})

pdf("mitch1_bespoke_heatmap01.pdf")
heatmap.2(mres1mx,trace="none",col=colfunc(25),scale="none", margins = c(10,28), cexRow=0.7,
  main="Neuronal pathways in hypothalamus" , cexCol=0.9 )

lapply(1:length(mysets2), function(i) {
  myset=mysets2[i]
  mygenes <- genesets[[which(names(genesets) == myset)]]
  allnames <- rownames(rpm1)
  allnames <- sapply(strsplit(allnames," "),"[[",2)
  mymx <- rpm1[which(allnames %in% mygenes),]
  mymx <- mymx[,colnames(mymx) %in% rownames(ss1)] # filter for those present in ss1
  mycols <- gsub("OVA","purple",gsub("LPS","orange",gsub("Control","green",ss1$Treatment)))

  heatmap.2(mymx,trace="none",col=colfunc(25),scale="row", margins = c(10,15), cexRow=0.7,
    ColSideColors=mycols,main=myset)
  mtext("Ctrl=green,LPS=orange,OVA=purple")
})
dev.off()

mysets2 <- genesets[names(genesets) %in% mysets2]
mres1b1 <- mitch_calc(m1, mysets2, priority="effect")
mitch_plots(res=mres1b1,outfile="mitch1_bespoke_charts.pdf")

## Immuno sets
mysets3 <- c("IMMUNOREGULATORY INTERACTIONS BETWEEN A LYMPHOID AND A NON LYMPHOID CELL",
"INTERFERON GAMMA SIGNALING",
"ENDOSOMAL VACUOLAR PATHWAY",
"INTERFERON ALPHA BETA SIGNALING")

mres1_bespoke <- mres1$enrichment_result[which(mres1$enrichment_result$set %in% mysets3),]
rownames(mres1_bespoke) <- mres1_bespoke$set

mres1_bespoke %>%
  kbl(caption = "Selected immune pathways in hypothalamus for LPS and OVA") %>%
  kable_paper("hover", full_width = F)

mres1mx <- as.matrix(mres1_bespoke[,c("s.LPS","s.OVA")])

heatmap.2(mres1mx,trace="none",col=colfunc(25),scale="none", margins = c(15,28), cexRow=0.7,
  main="Immune pathways in hypothalamus" , cexCol=0.9 )

lapply(1:length(mysets3), function(i) {
  myset=mysets3[i]
  mygenes <- genesets[[which(names(genesets) == myset)]]
  allnames <- rownames(rpm1)
  allnames <- sapply(strsplit(allnames," "),"[[",2)
  mymx <- rpm1[which(allnames %in% mygenes),]
  mymx <- mymx[,colnames(mymx) %in% rownames(ss1)] # filter for those present in ss1
  mycols <- gsub("OVA","purple",gsub("LPS","orange",gsub("Control","green",ss1$Treatment)))

  heatmap.2(mymx,trace="none",col=colfunc(25),scale="row", margins = c(10,15), cexRow=0.7,
    ColSideColors=mycols,main=myset)
  mtext("Ctrl=green,LPS=orange,OVA=purple")
})

pdf("mitch1_bespoke_heatmap02.pdf")
heatmap.2(mres1mx,trace="none",col=colfunc(25),scale="none", margins = c(10,28), cexRow=0.7,
  main="Immune pathways in hypothalamus" , cexCol=0.9 )

lapply(1:length(mysets3), function(i) {
  myset=mysets3[i]
  mygenes <- genesets[[which(names(genesets) == myset)]]
  allnames <- rownames(rpm1)
  allnames <- sapply(strsplit(allnames," "),"[[",2)
  mymx <- rpm1[which(allnames %in% mygenes),]
  mymx <- mymx[,colnames(mymx) %in% rownames(ss1)] # filter for those present in ss1
  mycols <- gsub("OVA","purple",gsub("LPS","orange",gsub("Control","green",ss1$Treatment)))

  heatmap.2(mymx,trace="none",col=colfunc(25),scale="row", margins = c(10,15), cexRow=0.7,
    ColSideColors=mycols,main=myset)
  mtext("Ctrl=green,LPS=orange,OVA=purple")
})
dev.off()

mysets3 <- genesets[names(genesets) %in% mysets3]
mres1b2 <- mitch_calc(m1, mysets3, priority="effect")
mitch_plots(res=mres1b2,outfile="mitch1_bespoke_charts2.pdf")

```

## Mitch pathway analysis in amygdala

Mitch for LPS in amy

```{r,mitch 2 lps}

m2_l <- mitch_import(dge2_l, DEtype="deseq2",geneTable=gt)
mres2_l <- mitch_calc(m2_l, genesets, priority="effect")
head(mres2_l$enrichment_result,20) %>%
  kbl(caption = "Top gene pathway differences in amy for LPS") %>%
  kable_paper("hover", full_width = F)
m2_l_top <- subset(mres2_l$enrichment_result,p.adjustANOVA<0.05)
m2_l_up <- subset(m2_l_top,s.dist>0)$set
m2_l_dn <- subset(m2_l_top,s.dist<0)$set
mitch_report(mres2_l,outfile="mitch2_l.html",overwrite=TRUE)
write.table(mres2_l$enrichment_result,file="mitch2_l.tsv",quote=FALSE,sep="\t",row.names=FALSE)

m2_l_top_up <- head(subset(m2_l_top,s.dist>0),10)[,"s.dist"]
names(m2_l_top_up) <- head(subset(m2_l_top,s.dist>0),10)[,"set"]
m2_l_top_dn <- head(subset(m2_l_top,s.dist<0),10)[,"s.dist"]
names(m2_l_top_dn) <- head(subset(m2_l_top,s.dist<0),10)[,"set"]
m2_l_top_updn <- c(m2_l_top_up,m2_l_top_dn)
m2_l_top_updn <- m2_l_top_updn[order(m2_l_top_updn)]

par(mar=c(5,25,3,1))
barplot(m2_l_top_updn,horiz=TRUE,las=1,col="darkgray",
  xlab="Enrichment score",cex.names=0.8,xlim=c(-1,1),
  main="Effect of LPS in amy")
grid()

pdf("plot23_mitch2lps01.pdf")
par(mar=c(5,25,3,1))
barplot(m2_l_top_updn,horiz=TRUE,las=1,col="darkgray",
  xlab="Enrichment score",cex.names=0.8,xlim=c(-1,1),
  main="Effect of LPS in amy")
grid()
dev.off()

```

Mitch for OVA in amy

```{r,mitch 2 ova}

m2_o <- mitch_import(dge2_o, DEtype="deseq2",geneTable=gt)
mres2_o <- mitch_calc(m2_o, genesets, priority="effect")
head(mres2_o$enrichment_result,20) %>%
  kbl(caption = "Top gene pathway differences in amy for OVA") %>%
  kable_paper("hover", full_width = F)
m2_o_top <- subset(mres2_o$enrichment_result,p.adjustANOVA<0.05)
m2_o_up <- subset(m2_o_top,s.dist>0)$set
m2_o_dn <- subset(m2_o_top,s.dist<0)$set
mitch_report(mres2_o,outfile="mitch2_o.html",overwrite=TRUE)
write.table(mres2_o$enrichment_result,file="mitch2_o.tsv",quote=FALSE,sep="\t",row.names=FALSE)

m2_o_top_up <- head(subset(m2_o_top,s.dist>0),10)[,"s.dist"]
names(m2_o_top_up) <- head(subset(m2_o_top,s.dist>0),10)[,"set"]
m2_o_top_dn <- head(subset(m2_o_top,s.dist<0),10)[,"s.dist"]
names(m2_o_top_dn) <- head(subset(m2_o_top,s.dist<0),10)[,"set"]
m2_o_top_updn <- c(m2_o_top_up,m2_o_top_dn)
m2_o_top_updn <- m2_o_top_updn[order(m2_o_top_updn)]

par(mar=c(5,25,3,1))
barplot(m2_o_top_updn,horiz=TRUE,las=1,col="darkgray",
  xlab="Enrichment score",cex.names=0.8,xlim=c(-1,1),
  main="Effect of LPS in amy")
grid()

pdf("plot24_mitch2ova01.pdf")
par(mar=c(5,25,3,1))
barplot(m2_o_top_updn,horiz=TRUE,las=1,col="darkgray",
  xlab="Enrichment score",cex.names=0.8,xlim=c(-1,1),
  main="Effect of LPS in amy")
grid()
dev.off()

```

Mitch 2 euler.

```{r,mitch 2 euler}

m2_l_up <- subset(m2_l_top,s.dist>0)$set
m2_l_dn <- subset(m2_l_top,s.dist<0)$set
m2_o_up <- subset(m2_o_top,s.dist>0)$set
m2_o_dn <- subset(m2_o_top,s.dist<0)$set

par(mar=c(2,2,2,2))

v0 <- list("LPS up"=m2_l_up,
  "LPS dn"=m2_l_dn,
  "OVA up"=m2_o_up,
  "OVA dn"=m2_o_dn)
plot(euler(v0),quantities = TRUE, edges = "gray", main="effect of treatments on amy")

pdf("plot25_mitch2lpsovaeuler01.pdf")
plot(euler(v0),quantities = TRUE, edges = "gray", main="effect of treatments on amy")
dev.off()

```

Two dimensional mitch analysis in amy.

```{r,mitch2_2d}

ml <- list("LPS"=dge2_l,"OVA"=dge2_o)
m2 <- mitch_import(ml, DEtype="deseq2",geneTable=gt)
head(m2)

mres2 <- mitch_calc(m2, genesets, priority="effect")

head(mres2$enrichment_result,20) %>%
  kbl(caption = "Top gene pathway differences in amy for LPS and OVA") %>%
  kable_paper("hover", full_width = F)
m2_top <- subset(mres2$enrichment_result,p.adjustMANOVA<0.05)
m2_up <- subset(m2_top,s.dist>0)$set
m2_dn <- subset(m2_top,s.dist<0)$set
mitch_plots(mres2, outfile="mres2.pdf")
mitch_report(mres2,outfile="mitch2.html",overwrite=TRUE)
write.table(mres2$enrichment_result,file="mitch2.tsv",quote=FALSE,sep="\t",row.names=FALSE)

m2_top_up <- head(subset(m2_top,s.dist>0),10)[,"s.dist"]
names(m2_top_up) <- head(subset(m2_top,s.dist>0),10)[,"set"]
m2_top_dn <- head(subset(m2_top,s.dist<0),10)[,"s.dist"]
names(m2_top_dn) <- head(subset(m2_top,s.dist<0),10)[,"set"]
m2_top_updn <- c(m2_top_up,m2_top_dn)
m2_top_updn <- m2_top_updn[order(m2_top_updn)]

# heatmap
mr2 <- head(mres2$enrichment_result,50)

rownames(mr2) <- mr2$set

#mr2 <- head(mres2$enrichment_result,50)
mr2 <- as.matrix(mr2[,4:5])

colfunc <- colorRampPalette(c("blue", "white", "red"))

heatmap.2(mr2,trace="none",col=colfunc(25),scale="none", margins = c(5,28), cexRow=0.6,
  main="Top ranked pathways in amy" , cexCol=0.9 )

pdf("plot26_mitch2_heatmap01.pdf")
heatmap.2(mr2,trace="none",col=colfunc(25),scale="none", margins = c(5,28), cexRow=0.6,
  main="Top ranked pathways in amy" , cexCol=0.9 )
dev.off()

```

Need to make a scatterplot to highlight the following:

* Serotonin Neurotransmitter Release Cycle (DN)
* Class C3 metabotropic glutamate pheromone receptors (DN)
* Regulation of commissural axon pathfinding by SLIT AND robo (DN)
* Reduction of Cytosolic Ca (DN)
* YAP1 and WWTR1 TAZ STIMULATED GENE EXPRESSION (UP)
* Activation of the mRNA upon binding (UP)
* Regulation of expression of slits and robs (UP)

```{r,mitch2_scatter}

par(mar=c(4,4,2,1))

a <- mres2$enrichment_result
plot(a$s.LPS , a$s.OVA,pch=19,col="gray")
abline(h=0,lty=2)
abline(v=0,lty=2)
as <- subset(a,p.adjustMANOVA<0.05)
points(as$s.LPS , as$s.OVA,pch=19,col="red")

abline(h=0.2,lty=2,col="red")
abline(v=0.2,lty=2,col="red")
abline(h=-0.2,lty=2,col="red")
abline(v=-0.2,lty=2,col="red")

mysets <- c("SEROTONIN NEUROTRANSMITTER RELEASE CYCLE",
  "CLASS C 3 METABOTROPIC GLUTAMATE PHEROMONE RECEPTORS",
  "REGULATION OF COMMISSURAL AXON PATHFINDING BY SLIT AND ROBO",
  "REDUCTION OF CYTOSOLIC CA LEVELS",
  "YAP1 AND WWTR1 TAZ STIMULATED GENE EXPRESSION",
  "ACTIVATION OF THE MRNA UPON BINDING OF THE CAP BINDING COMPLEX AND EIFS AND SUBSEQUENT BINDING TO 43S",
  "REGULATION OF EXPRESSION OF SLITS AND ROBOS")

a2 <- a[which(a$set %in% mysets),]

points(a2$s.LPS , a2$s.OVA+0.025,pch=25,col="red")

pdf("plot26b_mitch2_scatter01.pdf")

a <- mres2$enrichment_result
plot(a$s.LPS , a$s.OVA,pch=19,col="gray")
abline(h=0,lty=2)
abline(v=0,lty=2)
as <- subset(a,p.adjustMANOVA<0.05)
points(as$s.LPS , as$s.OVA,pch=19,col="red")

abline(h=0.2,lty=2,col="red")
abline(v=0.2,lty=2,col="red")
abline(h=-0.2,lty=2,col="red")
abline(v=-0.2,lty=2,col="red")

mysets <- c("SEROTONIN NEUROTRANSMITTER RELEASE CYCLE",
  "CLASS C 3 METABOTROPIC GLUTAMATE PHEROMONE RECEPTORS",
  "REGULATION OF COMMISSURAL AXON PATHFINDING BY SLIT AND ROBO",
  "REDUCTION OF CYTOSOLIC CA LEVELS",
  "YAP1 AND WWTR1 TAZ STIMULATED GENE EXPRESSION",
  "ACTIVATION OF THE MRNA UPON BINDING OF THE CAP BINDING COMPLEX AND EIFS AND SUBSEQUENT BINDING TO 43S",
  "REGULATION OF EXPRESSION OF SLITS AND ROBOS")

a2 <- a[which(a$set %in% mysets),]

points(a2$s.LPS , a2$s.OVA+0.025,pch=25,col="red")

dev.off()

```

## Mitch pathway analysis in hippocampus

Mitch for LPS in hip

```{r,mitch 3 lps}

m3_l <- mitch_import(dge3_l, DEtype="deseq2",geneTable=gt)
mres3_l <- mitch_calc(m3_l, genesets, priority="effect")
head(mres3_l$enrichment_result,20) %>%
  kbl(caption = "Top gene pathway differences in hip for LPS") %>%
  kable_paper("hover", full_width = F)
m3_l_top <- subset(mres3_l$enrichment_result,p.adjustANOVA<0.05)
m3_l_up <- subset(m3_l_top,s.dist>0)$set
m3_l_dn <- subset(m3_l_top,s.dist<0)$set
mitch_report(mres3_l,outfile="mitch3_l.html",overwrite=TRUE)
write.table(mres3_l$enrichment_result,file="mitch3_l.tsv",quote=FALSE,sep="\t",row.names=FALSE)

m3_l_top_up <- head(subset(m3_l_top,s.dist>0),10)[,"s.dist"]
names(m3_l_top_up) <- head(subset(m3_l_top,s.dist>0),10)[,"set"]
m3_l_top_dn <- head(subset(m3_l_top,s.dist<0),10)[,"s.dist"]
names(m3_l_top_dn) <- head(subset(m3_l_top,s.dist<0),10)[,"set"]
m3_l_top_updn <- c(m3_l_top_up,m3_l_top_dn)
m3_l_top_updn <- m3_l_top_updn[order(m3_l_top_updn)]

par(mar=c(5,25,3,1))
barplot(m3_l_top_updn,horiz=TRUE,las=1,col="darkgray",
  xlab="Enrichment score",cex.names=0.8,xlim=c(-1,1),
  main="Effect of LPS in hip")
grid()

pdf("plot27_mitch3lps01.pdf")
par(mar=c(5,25,3,1))
barplot(m3_l_top_updn,horiz=TRUE,las=1,col="darkgray",
  xlab="Enrichment score",cex.names=0.8,xlim=c(-1,1),
  main="Effect of LPS in hip")
grid()
dev.off()

```

Mitch for OVA in hip

```{r,mitch 3 ova}

m3_o <- mitch_import(dge3_o, DEtype="deseq2",geneTable=gt)
mres3_o <- mitch_calc(m3_o, genesets, priority="effect")
head(mres3_o$enrichment_result,20) %>%
  kbl(caption = "Top gene pathway differences in hip for OVA") %>%
  kable_paper("hover", full_width = F)
m3_o_top <- subset(mres3_o$enrichment_result,p.adjustANOVA<0.05)
m3_o_up <- subset(m3_o_top,s.dist>0)$set
m3_o_dn <- subset(m3_o_top,s.dist<0)$set
mitch_report(mres3_o,outfile="mitch3_o.html",overwrite=TRUE)
write.table(mres3_o$enrichment_result,file="mitch3_o.tsv",quote=FALSE,sep="\t",row.names=FALSE)

m3_o_top_up <- head(subset(m3_o_top,s.dist>0),10)[,"s.dist"]
names(m3_o_top_up) <- head(subset(m3_o_top,s.dist>0),10)[,"set"]
m3_o_top_dn <- head(subset(m3_o_top,s.dist<0),10)[,"s.dist"]
names(m3_o_top_dn) <- head(subset(m3_o_top,s.dist<0),10)[,"set"]
m3_o_top_updn <- c(m3_o_top_up,m3_o_top_dn)
m3_o_top_updn <- m3_o_top_updn[order(m3_o_top_updn)]

par(mar=c(5,25,3,1))
barplot(m3_o_top_updn,horiz=TRUE,las=1,col="darkgray",
  xlab="Enrichment score",cex.names=0.8,xlim=c(-1,1),
  main="Effect of LPS in hip")
grid()

pdf("plot28_mitch3ova01.pdf")
par(mar=c(5,25,3,1))
barplot(m3_o_top_updn,horiz=TRUE,las=1,col="darkgray",
  xlab="Enrichment score",cex.names=0.8,xlim=c(-1,1),
  main="Effect of LPS in hip")
grid()
dev.off()

```

Mitch 3 euler.

```{r,mitch 3 euler}

m3_l_up <- subset(m3_l_top,s.dist>0)$set
m3_l_dn <- subset(m3_l_top,s.dist<0)$set
m3_o_up <- subset(m3_o_top,s.dist>0)$set
m3_o_dn <- subset(m3_o_top,s.dist<0)$set

par(mar=c(2,2,2,2))

v0 <- list("LPS up"=m3_l_up,
  "LPS dn"=m3_l_dn,
  "OVA up"=m3_o_up,
  "OVA dn"=m3_o_dn)
plot(euler(v0),quantities = TRUE, edges = "gray", main="effect of treatments on hip")

pdf("plot29_mitch3lpsovaeuler01.pdf")
plot(euler(v0),quantities = TRUE, edges = "gray", main="effect of treatments on hip")
dev.off()

```

Two dimensional mitch analysis in hip.

```{r,mitch3_2d}

ml <- list("LPS"=dge3_l,"OVA"=dge3_o)
m3 <- mitch_import(ml, DEtype="deseq2",geneTable=gt)
head(m3)

mres3 <- mitch_calc(m3, genesets, priority="effect")

head(mres3$enrichment_result,20) %>%
  kbl(caption = "Top gene pathway differences in hip for LPS and OVA") %>%
  kable_paper("hover", full_width = F)
m3_top <- subset(mres3$enrichment_result,p.adjustMANOVA<0.05)
m3_up <- subset(m3_top,s.dist>0)$set
m3_dn <- subset(m3_top,s.dist<0)$set
mitch_plots(mres3, outfile="mres3.pdf")
mitch_report(mres3,outfile="mitch3.html",overwrite=TRUE)
write.table(mres3$enrichment_result,file="mitch3.tsv",quote=FALSE,sep="\t",row.names=FALSE)

m3_top_up <- head(subset(m3_top,s.dist>0),10)[,"s.dist"]
names(m3_top_up) <- head(subset(m3_top,s.dist>0),10)[,"set"]
m3_top_dn <- head(subset(m3_top,s.dist<0),10)[,"s.dist"]
names(m3_top_dn) <- head(subset(m3_top,s.dist<0),10)[,"set"]
m3_top_updn <- c(m3_top_up,m3_top_dn)
m3_top_updn <- m3_top_updn[order(m3_top_updn)]

# heatmap
mr3 <- head(mres3$enrichment_result,50)

rownames(mr3) <- mr3$set
mr3 <- as.matrix(mr3[,4:5])

colfunc <- colorRampPalette(c("blue", "white", "red"))

heatmap.2(mr3,trace="none",col=colfunc(25),scale="none", margins = c(5,28), cexRow=0.6,
  main="Top ranked pathways in hip" , cexCol=0.9 )

pdf("plot30_mitch3_heatmap01.pdf")
heatmap.2(mr3,trace="none",col=colfunc(25),scale="none", margins = c(5,28), cexRow=0.6,
  main="Top ranked pathways in hip" , cexCol=0.9 )
dev.off()


```

Need to make a scatterplot to highlight the following:

* Serotonin Neurotransmitter Release Cycle (DN)
* Class C3 metabotropic glutamate pheromone receptors (DN)
* Regulation of commissural axon pathfinding by SLIT AND robo (DN)
* Reduction of Cytosolic Ca (DN)
* YAP1 and WWTR1 TAZ STIMULATED GENE EXPRESSION (UP)
* Activation of the mRNA upon binding (UP)
* Regulation of expression of slits and robs (UP)

```{r,mitch3_scatter}

par(mar=c(4,4,2,1))

a <- mres3$enrichment_result
plot(a$s.LPS , a$s.OVA,pch=19,col="gray")
abline(h=0,lty=2)
abline(v=0,lty=2)
as <- subset(a,p.adjustMANOVA<0.05)
points(as$s.LPS , as$s.OVA,pch=19,col="red")

abline(h=0.2,lty=2,col="red")
abline(v=0.2,lty=2,col="red")
abline(h=-0.2,lty=2,col="red")
abline(v=-0.2,lty=2,col="red")

mysets <- c("SEROTONIN NEUROTRANSMITTER RELEASE CYCLE",
  "CLASS C 3 METABOTROPIC GLUTAMATE PHEROMONE RECEPTORS",
  "REGULATION OF COMMISSURAL AXON PATHFINDING BY SLIT AND ROBO",
  "REDUCTION OF CYTOSOLIC CA LEVELS",
  "YAP1 AND WWTR1 TAZ STIMULATED GENE EXPRESSION",
  "ACTIVATION OF THE MRNA UPON BINDING OF THE CAP BINDING COMPLEX AND EIFS AND SUBSEQUENT BINDING TO 43S",
  "REGULATION OF EXPRESSION OF SLITS AND ROBOS")

a2 <- a[which(a$set %in% mysets),]

points(a2$s.LPS , a2$s.OVA+0.025,pch=25,col="red")

pdf("plot30b_mitch3_scatter01.pdf")

a <- mres3$enrichment_result
plot(a$s.LPS , a$s.OVA,pch=19,col="gray")
abline(h=0,lty=2)
abline(v=0,lty=2)
as <- subset(a,p.adjustMANOVA<0.05)
points(as$s.LPS , as$s.OVA,pch=19,col="red")

abline(h=0.2,lty=2,col="red")
abline(v=0.2,lty=2,col="red")
abline(h=-0.2,lty=2,col="red")
abline(v=-0.2,lty=2,col="red")

mysets <- c("SEROTONIN NEUROTRANSMITTER RELEASE CYCLE",
  "CLASS C 3 METABOTROPIC GLUTAMATE PHEROMONE RECEPTORS",
  "REGULATION OF COMMISSURAL AXON PATHFINDING BY SLIT AND ROBO",
  "REDUCTION OF CYTOSOLIC CA LEVELS",
  "YAP1 AND WWTR1 TAZ STIMULATED GENE EXPRESSION",
  "ACTIVATION OF THE MRNA UPON BINDING OF THE CAP BINDING COMPLEX AND EIFS AND SUBSEQUENT BINDING TO 43S",
  "REGULATION OF EXPRESSION OF SLITS AND ROBOS")

a2 <- a[which(a$set %in% mysets),]

points(a2$s.LPS , a2$s.OVA+0.025,pch=25,col="red")

dev.off()

```

## Bespoke analysis

As discussed before, could you please generate a Combined Heatmap with total 4 columns (Amygdala and Hippocampus):
(common gene sets between these 2 brain regions; these will be (Figure 2A in the paper showing similar directionality);
(Figure 2B in the paper showing opposite directionality) (in PDF format).

```{r,mitch23_combined}

ml <- list( "amy LPS"=dge2_l,"amy OVA"=dge2_o ,"hip LPS"=dge3_l,"hip OVA"=dge3_o)
m23 <- mitch_import(ml, DEtype="deseq2",geneTable=gt)
head(m23)

mres23 <- mitch_calc(m23, genesets, priority="effect")

head(mres23$enrichment_result,20) %>%
  kbl(caption = "Top gene pathway differences in amy and hip for LPS and OVA") %>%
  kable_paper("hover", full_width = F)

#mitch_report(mres23,outfile="mitch23.html",overwrite=TRUE)
write.table(mres23$enrichment_result,file="mitch23.tsv",quote=FALSE,sep="\t",row.names=FALSE)

# heatmap
mr23 <- head(subset(mres23$enrichment_result,p.adjustMANOVA<0.05),30)
mr23 <- as.matrix(mr23[,4:7])
rownames(mr23) <- head(mres23$enrichment_result,30)$set

colfunc <- colorRampPalette(c("blue", "white", "red"))

heatmap.2(mr23,trace="none",col=colfunc(25),scale="none", margins = c(10,25), cexRow=0.65,
  main="Top ranked pathways in amy/hip" , cexCol=0.9 )

pdf("plot40_mitch23_heatmap01.pdf")
heatmap.2(mr23,trace="none",col=colfunc(25),scale="none", margins = c(10,25), cexRow=0.65,
  main="Top ranked pathways in amy/hip" , cexCol=0.9 )
dev.off()

# now select 30 sets from mres2 and mres3
n=17
mysets <- union( head(mres2$enrichment_result,n)$set , head(mres3$enrichment_result,n)$set )
mr23 <- mres23$enrichment_result[which(mres23$enrichment_result$set %in% mysets),]
rownames(mr23) <- mr23$set
mr23 <- as.matrix(mr23[,4:7])

heatmap.2(mr23,trace="none",col=colfunc(25),scale="none", margins = c(10,25), cexRow=0.65,
  main="Top ranked pathways in amy/hip" , cexCol=0.9 )

pdf("plot41_mitch23_heatmap01.pdf")
heatmap.2(mr23,trace="none",col=colfunc(25),scale="none", margins = c(10,25), cexRow=0.65,
  main="Top ranked pathways in amy/hip" , cexCol=0.9 )
dev.off()

```

Discordant analysis.

```{r,mitch23_combined_discordant}

mres23d <- mitch_calc(m23, genesets, priority="SD")

head(mres23d$enrichment_result,20) %>%
  kbl(caption = "Top gene pathway differences in amy and hip for LPS and OVA (discordant)") %>%
  kable_paper("hover", full_width = F)

# heatmap
mr23d <- head(subset(mres23d$enrichment_result,p.adjustMANOVA<0.05),30)
rownames(mr23d) <- mr23d$set
mr23d <- as.matrix(mr23d[,4:7])

heatmap.2(mr23d,trace="none",col=colfunc(25),scale="none", margins = c(10,25), cexRow=0.65,
  main="Top ranked pathways in amy/hip (discordant)" , cexCol=0.9 )

pdf("plot42_mitch23d_heatmap01.pdf")
heatmap.2(mr23d,trace="none",col=colfunc(25),scale="none", margins = c(10,25), cexRow=0.65,
  main="Top ranked pathways in amy/hip (discordant)" , cexCol=0.9 )
dev.off()

ml2d <- list("LPS"=dge2_l,"OVA"=dge2_o)
m2d <- mitch_import(ml2d, DEtype="deseq2",geneTable=gt)
mres2d <- mitch_calc(m2d, genesets, priority="SD")
head(mres2d$enrichment_result)

ml3d <- list("LPS"=dge3_l,"OVA"=dge3_o)
m3d <- mitch_import(ml3d, DEtype="deseq2",geneTable=gt)
mres3d <- mitch_calc(m3d, genesets, priority="SD")
head(mres3d$enrichment_result)

mysets <- union(head(mres2d$enrichment_result,15)$set , head(mres3d$enrichment_result,15)$set)
mr23d <- mres23d$enrichment_result[mres23d$enrichment_result$set %in% mysets,]
rownames(mr23d) <- mr23d$set
mr23d <- as.matrix(mr23d[,4:7])

heatmap.2(mr23d,trace="none",col=colfunc(25),scale="none", margins = c(10,25), cexRow=0.65,
  main="Top ranked pathways in amy/hip (discordant)" , cexCol=0.9 )

pdf("plot43_mitch23d_heatmap01.pdf")
heatmap.2(mr23d,trace="none",col=colfunc(25),scale="none", margins = c(10,25), cexRow=0.65,
  main="Top ranked pathways in amy/hip (discordant)" , cexCol=0.9 )
dev.off()

```

## Mitch pathway analysis in PAG

Mitch for LPS in pag

```{r,mitch 4 lps}

m4_l <- mitch_import(dge4_l, DEtype="deseq2",geneTable=gt)
mres4_l <- mitch_calc(m4_l, genesets, priority="effect")
head(mres4_l$enrichment_result,20) %>%
  kbl(caption = "Top gene pathway differences in pag for LPS") %>%
  kable_paper("hover", full_width = F)
m4_l_top <- subset(mres4_l$enrichment_result,p.adjustANOVA<0.05)
m4_l_up <- subset(m4_l_top,s.dist>0)$set
m4_l_dn <- subset(m4_l_top,s.dist<0)$set
mitch_report(mres4_l,outfile="mitch4_l.html",overwrite=TRUE)
write.table(mres4_l$enrichment_result,file="mitch4_l.tsv",quote=FALSE,sep="\t",row.names=FALSE)

m4_l_top_up <- head(subset(m4_l_top,s.dist>0),10)[,"s.dist"]
names(m4_l_top_up) <- head(subset(m4_l_top,s.dist>0),10)[,"set"]
m4_l_top_dn <- head(subset(m4_l_top,s.dist<0),10)[,"s.dist"]
names(m4_l_top_dn) <- head(subset(m4_l_top,s.dist<0),10)[,"set"]
m4_l_top_updn <- c(m4_l_top_up,m4_l_top_dn)
m4_l_top_updn <- m4_l_top_updn[order(m4_l_top_updn)]

par(mar=c(5,25,3,1))
barplot(m4_l_top_updn,horiz=TRUE,las=1,col="darkgray",
  xlab="Enrichment score",cex.names=0.8,xlim=c(-1,1),
  main="Effect of LPS in pag")
grid()

pdf("plot31_mitch4lps01.pdf")
par(mar=c(5,25,3,1))
barplot(m4_l_top_updn,horiz=TRUE,las=1,col="darkgray",
  xlab="Enrichment score",cex.names=0.8,xlim=c(-1,1),
  main="Effect of LPS in pag")
grid()
dev.off()

```

Mitch for OVA in pag

```{r,mitch 4 ova}

m4_o <- mitch_import(dge4_o, DEtype="deseq2",geneTable=gt)
mres4_o <- mitch_calc(m4_o, genesets, priority="effect")
head(mres4_o$enrichment_result,20) %>%
  kbl(caption = "Top gene pathway differences in pag for OVA") %>%
  kable_paper("hover", full_width = F)
m4_o_top <- subset(mres4_o$enrichment_result,p.adjustANOVA<0.05)
m4_o_up <- subset(m4_o_top,s.dist>0)$set
m4_o_dn <- subset(m4_o_top,s.dist<0)$set
mitch_report(mres4_o,outfile="mitch4_o.html",overwrite=TRUE)
write.table(mres4_o$enrichment_result,file="mitch4_o.tsv",quote=FALSE,sep="\t",row.names=FALSE)

m4_o_top_up <- head(subset(m4_o_top,s.dist>0),10)[,"s.dist"]
names(m4_o_top_up) <- head(subset(m4_o_top,s.dist>0),10)[,"set"]
m4_o_top_dn <- head(subset(m4_o_top,s.dist<0),10)[,"s.dist"]
names(m4_o_top_dn) <- head(subset(m4_o_top,s.dist<0),10)[,"set"]
m4_o_top_updn <- c(m4_o_top_up,m4_o_top_dn)
m4_o_top_updn <- m4_o_top_updn[order(m4_o_top_updn)]

par(mar=c(5,25,3,1))
barplot(m4_o_top_updn,horiz=TRUE,las=1,col="darkgray",
  xlab="Enrichment score",cex.names=0.8,xlim=c(-1,1),
  main="Effect of LPS in pag")
grid()

pdf("plot32_mitch4ova01.pdf")
par(mar=c(5,25,3,1))
barplot(m4_o_top_updn,horiz=TRUE,las=1,col="darkgray",
  xlab="Enrichment score",cex.names=0.8,xlim=c(-1,1),
  main="Effect of LPS in pag")
grid()
dev.off()

```

Mitch 4 euler.

```{r,mitch 4 euler}

m4_l_up <- subset(m4_l_top,s.dist>0)$set
m4_l_dn <- subset(m4_l_top,s.dist<0)$set
m4_o_up <- subset(m4_o_top,s.dist>0)$set
m4_o_dn <- subset(m4_o_top,s.dist<0)$set

par(mar=c(2,2,2,2))

v0 <- list("LPS up"=m4_l_up,
  "LPS dn"=m4_l_dn,
  "OVA up"=m4_o_up,
  "OVA dn"=m4_o_dn)
plot(euler(v0),quantities = TRUE, edges = "gray", main="effect of treatments on pag")

pdf("plot33_mitch4lpsovaeuler01.pdf")
plot(euler(v0),quantities = TRUE, edges = "gray", main="effect of treatments on pag")
dev.off()

```

Two dimensional mitch analysis in pag.

```{r,mitch4_2d}

ml <- list("LPS"=dge4_l,"OVA"=dge4_o)
m4 <- mitch_import(ml, DEtype="deseq2",geneTable=gt)
head(m4)

mres4 <- mitch_calc(m4, genesets, priority="effect")

head(mres4$enrichment_result,20) %>%
  kbl(caption = "Top gene pathway differences in pag for LPS and OVA") %>%
  kable_paper("hover", full_width = F)
m4_top <- subset(mres4$enrichment_result,p.adjustMANOVA<0.05)
m4_up <- subset(m4_top,s.dist>0)$set
m4_dn <- subset(m4_top,s.dist<0)$set
mitch_report(mres4,outfile="mitch4.html",overwrite=TRUE)
write.table(mres4$enrichment_result,file="mitch4.tsv",quote=FALSE,sep="\t",row.names=FALSE)

m4_top_up <- head(subset(m4_top,s.dist>0),10)[,"s.dist"]
names(m4_top_up) <- head(subset(m4_top,s.dist>0),10)[,"set"]
m4_top_dn <- head(subset(m4_top,s.dist<0),10)[,"s.dist"]
names(m4_top_dn) <- head(subset(m4_top,s.dist<0),10)[,"set"]
m4_top_updn <- c(m4_top_up,m4_top_dn)
m4_top_updn <- m4_top_updn[order(m4_top_updn)]

# heatmap
mr4 <- head(subset(mres4$enrichment_result,p.adjustMANOVA<0.05),30)
mr4 <- as.matrix(mr4[,4:5])
rownames(mr4) <- head(mres4$enrichment_result,30)$set

colfunc <- colorRampPalette(c("blue", "white", "red"))

heatmap.2(mr4,trace="none",col=colfunc(25),scale="none", margins = c(10,28), cexRow=0.7,
  main="Top ranked pathways in pag" , cexCol=0.9 )

pdf("plot34_mitch4_heatmap01.pdf")
heatmap.2(mr4,trace="none",col=colfunc(25),scale="none", margins = c(10,28), cexRow=0.7,
  main="Top ranked pathways in pag" , cexCol=0.9 )
dev.off()

```

Need to make a scatterplot to highlight the following:

* Serotonin Neurotransmitter Release Cycle (DN)
* Class C3 metabotropic glutamate pheromone receptors (DN)
* Regulation of commissural axon pathfinding by SLIT AND robo (DN)
* Reduction of Cytosolic Ca (DN)
* YAP1 and WWTR1 TAZ STIMULATED GENE EXPRESSION (UP)
* Activation of the mRNA upon binding (UP)
* Regulation of expression of slits and robs (UP)

```{r,mitch4_scatter}

par(mar=c(4,4,2,1))

a <- mres4$enrichment_result
plot(a$s.LPS , a$s.OVA,pch=19,col="gray")
abline(h=0,lty=2)
abline(v=0,lty=2)
as <- subset(a,p.adjustMANOVA<0.05)
points(as$s.LPS , as$s.OVA,pch=19,col="red")

abline(h=0.2,lty=2,col="red")
abline(v=0.2,lty=2,col="red")
abline(h=-0.2,lty=2,col="red")
abline(v=-0.2,lty=2,col="red")

mysets <- c("SEROTONIN NEUROTRANSMITTER RELEASE CYCLE",
  "CLASS C 3 METABOTROPIC GLUTAMATE PHEROMONE RECEPTORS",
  "REGULATION OF COMMISSURAL AXON PATHFINDING BY SLIT AND ROBO",
  "REDUCTION OF CYTOSOLIC CA LEVELS",
  "YAP1 AND WWTR1 TAZ STIMULATED GENE EXPRESSION",
  "ACTIVATION OF THE MRNA UPON BINDING OF THE CAP BINDING COMPLEX AND EIFS AND SUBSEQUENT BINDING TO 43S",
  "REGULATION OF EXPRESSION OF SLITS AND ROBOS")

a2 <- a[which(a$set %in% mysets),]

points(a2$s.LPS , a2$s.OVA+0.025,pch=25,col="red")

pdf("plot34b_mitch4_scatter01.pdf")

a <- mres4$enrichment_result
plot(a$s.LPS , a$s.OVA,pch=19,col="gray")
abline(h=0,lty=2)
abline(v=0,lty=2)
as <- subset(a,p.adjustMANOVA<0.05)
points(as$s.LPS , as$s.OVA,pch=19,col="red")

abline(h=0.2,lty=2,col="red")
abline(v=0.2,lty=2,col="red")
abline(h=-0.2,lty=2,col="red")
abline(v=-0.2,lty=2,col="red")

mysets <- c("SEROTONIN NEUROTRANSMITTER RELEASE CYCLE",
  "CLASS C 3 METABOTROPIC GLUTAMATE PHEROMONE RECEPTORS",
  "REGULATION OF COMMISSURAL AXON PATHFINDING BY SLIT AND ROBO",
  "REDUCTION OF CYTOSOLIC CA LEVELS",
  "YAP1 AND WWTR1 TAZ STIMULATED GENE EXPRESSION",
  "ACTIVATION OF THE MRNA UPON BINDING OF THE CAP BINDING COMPLEX AND EIFS AND SUBSEQUENT BINDING TO 43S",
  "REGULATION OF EXPRESSION OF SLITS AND ROBOS")

a2 <- a[which(a$set %in% mysets),]

points(a2$s.LPS , a2$s.OVA+0.025,pch=25,col="red")

dev.off()

```

## Mitch pathway analysis in NI

Mitch for LPS in NI

```{r,mitch 5 lps}

m5_l <- mitch_import(dge5_l, DEtype="deseq2",geneTable=gt)
mres5_l <- mitch_calc(m5_l, genesets, priority="effect")
head(mres5_l$enrichment_result,20) %>%
  kbl(caption = "Top gene pathway differences in NI for LPS") %>%
  kable_paper("hover", full_width = F)
m5_l_top <- subset(mres5_l$enrichment_result,p.adjustANOVA<0.05)
m5_l_up <- subset(m5_l_top,s.dist>0)$set
m5_l_dn <- subset(m5_l_top,s.dist<0)$set
mitch_report(mres5_l,outfile="mitch5_l.html",overwrite=TRUE)
write.table(mres5_l$enrichment_result,file="mitch5_l.tsv",quote=FALSE,sep="\t",row.names=FALSE)

m5_l_top_up <- head(subset(m5_l_top,s.dist>0),10)[,"s.dist"]
names(m5_l_top_up) <- head(subset(m5_l_top,s.dist>0),10)[,"set"]
m5_l_top_dn <- head(subset(m5_l_top,s.dist<0),10)[,"s.dist"]
names(m5_l_top_dn) <- head(subset(m5_l_top,s.dist<0),10)[,"set"]
m5_l_top_updn <- c(m5_l_top_up,m5_l_top_dn)
m5_l_top_updn <- m5_l_top_updn[order(m5_l_top_updn)]

par(mar=c(5,25,3,1))
barplot(m5_l_top_updn,horiz=TRUE,las=1,col="darkgray",
  xlab="Enrichment score",cex.names=0.8,xlim=c(-1,1),
  main="Effect of LPS in NI")
grid()

pdf("plot35_mitch5lps01.pdf")
par(mar=c(5,25,3,1))
barplot(m5_l_top_updn,horiz=TRUE,las=1,col="darkgray",
  xlab="Enrichment score",cex.names=0.8,xlim=c(-1,1),
  main="Effect of LPS in NI")
grid()
dev.off()

```

Mitch for OVA in NI

```{r,mitch 5 ova}

m5_o <- mitch_import(dge5_o, DEtype="deseq2",geneTable=gt)
mres5_o <- mitch_calc(m5_o, genesets, priority="effect")
head(mres5_o$enrichment_result,20) %>%
  kbl(caption = "Top gene pathway differences in NI for OVA") %>%
  kable_paper("hover", full_width = F)
m5_o_top <- subset(mres5_o$enrichment_result,p.adjustANOVA<0.05)
m5_o_up <- subset(m5_o_top,s.dist>0)$set
m5_o_dn <- subset(m5_o_top,s.dist<0)$set
mitch_report(mres5_o,outfile="mitch5_o.html",overwrite=TRUE)
write.table(mres5_o$enrichment_result,file="mitch5_o.tsv",quote=FALSE,sep="\t",row.names=FALSE)

m5_o_top_up <- head(subset(m5_o_top,s.dist>0),10)[,"s.dist"]
names(m5_o_top_up) <- head(subset(m5_o_top,s.dist>0),10)[,"set"]
m5_o_top_dn <- head(subset(m5_o_top,s.dist<0),10)[,"s.dist"]
names(m5_o_top_dn) <- head(subset(m5_o_top,s.dist<0),10)[,"set"]
m5_o_top_updn <- c(m5_o_top_up,m5_o_top_dn)
m5_o_top_updn <- m5_o_top_updn[order(m5_o_top_updn)]

par(mar=c(5,25,3,1))
barplot(m5_o_top_updn,horiz=TRUE,las=1,col="darkgray",
  xlab="Enrichment score",cex.names=0.8,xlim=c(-1,1),
  main="Effect of LPS in NI")
grid()

pdf("plot36_mitch5ova01.pdf")
par(mar=c(5,25,3,1))
barplot(m5_o_top_updn,horiz=TRUE,las=1,col="darkgray",
  xlab="Enrichment score",cex.names=0.8,xlim=c(-1,1),
  main="Effect of LPS in NI")
grid()
dev.off()

```

Mitch 5 euler.

```{r,mitch 5 euler}

m5_l_up <- subset(m5_l_top,s.dist>0)$set
m5_l_dn <- subset(m5_l_top,s.dist<0)$set
m5_o_up <- subset(m5_o_top,s.dist>0)$set
m5_o_dn <- subset(m5_o_top,s.dist<0)$set

par(mar=c(2,2,2,2))

v0 <- list("LPS up"=m5_l_up,
  "LPS dn"=m5_l_dn,
  "OVA up"=m5_o_up,
  "OVA dn"=m5_o_dn)
plot(euler(v0),quantities = TRUE, edges = "gray", main="effect of treatments on NI")

pdf("plot37_mitch5lpsovaeuler01.pdf")
plot(euler(v0),quantities = TRUE, edges = "gray", main="effect of treatments on NI")
dev.off()

```

Two dimensional mitch analysis in NI.

```{r,mitch5_2d}

ml <- list("LPS"=dge5_l,"OVA"=dge5_o)
m5 <- mitch_import(ml, DEtype="deseq2",geneTable=gt)
head(m5)

mres5 <- mitch_calc(m5, genesets, priority="effect")

head(mres5$enrichment_result,20) %>%
  kbl(caption = "Top gene pathway differences in NI for LPS and OVA") %>%
  kable_paper("hover", full_width = F)
m5_top <- subset(mres5$enrichment_result,p.adjustMANOVA<0.05)
m5_up <- subset(m5_top,s.dist>0)$set
m5_dn <- subset(m5_top,s.dist<0)$set
mitch_report(mres5,outfile="mitch5.html",overwrite=TRUE)
write.table(mres5$enrichment_result,file="mitch5.tsv",quote=FALSE,sep="\t",row.names=FALSE)

m5_top_up <- head(subset(m5_top,s.dist>0),10)[,"s.dist"]
names(m5_top_up) <- head(subset(m5_top,s.dist>0),10)[,"set"]
m5_top_dn <- head(subset(m5_top,s.dist<0),10)[,"s.dist"]
names(m5_top_dn) <- head(subset(m5_top,s.dist<0),10)[,"set"]
m5_top_updn <- c(m5_top_up,m5_top_dn)
m5_top_updn <- m5_top_updn[order(m5_top_updn)]

# heatmap
mr5 <- head(subset(mres5$enrichment_result,p.adjustMANOVA<0.05),30)
mr5 <- as.matrix(mr5[,4:5])
rownames(mr5) <- head(mres5$enrichment_result,30)$set

colfunc <- colorRampPalette(c("blue", "white", "red"))

heatmap.2(mr5,trace="none",col=colfunc(25),scale="none", margins = c(10,28), cexRow=0.7,
  main="Top ranked pathways in NI" , cexCol=0.9 )

pdf("plot37_mitch5_heatmap01.pdf")
heatmap.2(mr5,trace="none",col=colfunc(25),scale="none", margins = c(10,28), cexRow=0.7,
  main="Top ranked pathways in NI" , cexCol=0.9 )
dev.off()

```

Need to make a scatterplot to highlight the following:

* Serotonin Neurotransmitter Release Cycle (DN)
* Class C3 metabotropic glutamate pheromone receptors (DN)
* Regulation of commissural axon pathfinding by SLIT AND robo (DN)
* Reduction of Cytosolic Ca (DN)
* YAP1 and WWTR1 TAZ STIMULATED GENE EXPRESSION (UP)
* Activation of the mRNA upon binding (UP)
* Regulation of expression of slits and robs (UP)

```{r,mitch5_scatter}

par(mar=c(4,4,2,1))

a <- mres5$enrichment_result
plot(a$s.LPS , a$s.OVA,pch=19,col="gray")
abline(h=0,lty=2)
abline(v=0,lty=2)
as <- subset(a,p.adjustMANOVA<0.05)
points(as$s.LPS , as$s.OVA,pch=19,col="red")

abline(h=0.2,lty=2,col="red")
abline(v=0.2,lty=2,col="red")
abline(h=-0.2,lty=2,col="red")
abline(v=-0.2,lty=2,col="red")

mysets <- c("SEROTONIN NEUROTRANSMITTER RELEASE CYCLE",
  "CLASS C 3 METABOTROPIC GLUTAMATE PHEROMONE RECEPTORS",
  "REGULATION OF COMMISSURAL AXON PATHFINDING BY SLIT AND ROBO",
  "REDUCTION OF CYTOSOLIC CA LEVELS",
  "YAP1 AND WWTR1 TAZ STIMULATED GENE EXPRESSION",
  "ACTIVATION OF THE MRNA UPON BINDING OF THE CAP BINDING COMPLEX AND EIFS AND SUBSEQUENT BINDING TO 43S",
  "REGULATION OF EXPRESSION OF SLITS AND ROBOS")

a2 <- a[which(a$set %in% mysets),]

points(a2$s.LPS , a2$s.OVA+0.025,pch=25,col="red")

pdf("plot37b_mitch5_scatter01.pdf")

a <- mres5$enrichment_result
plot(a$s.LPS , a$s.OVA,pch=19,col="gray")
abline(h=0,lty=2)
abline(v=0,lty=2)
as <- subset(a,p.adjustMANOVA<0.05)
points(as$s.LPS , as$s.OVA,pch=19,col="red")

abline(h=0.2,lty=2,col="red")
abline(v=0.2,lty=2,col="red")
abline(h=-0.2,lty=2,col="red")
abline(v=-0.2,lty=2,col="red")

mysets <- c("SEROTONIN NEUROTRANSMITTER RELEASE CYCLE",
  "CLASS C 3 METABOTROPIC GLUTAMATE PHEROMONE RECEPTORS",
  "REGULATION OF COMMISSURAL AXON PATHFINDING BY SLIT AND ROBO",
  "REDUCTION OF CYTOSOLIC CA LEVELS",
  "YAP1 AND WWTR1 TAZ STIMULATED GENE EXPRESSION",
  "ACTIVATION OF THE MRNA UPON BINDING OF THE CAP BINDING COMPLEX AND EIFS AND SUBSEQUENT BINDING TO 43S",
  "REGULATION OF EXPRESSION OF SLITS AND ROBOS")

a2 <- a[which(a$set %in% mysets),]

points(a2$s.LPS , a2$s.OVA+0.025,pch=25,col="red")

dev.off()

```

## Mitch pathway analysis - LPS all tissues

```{r,mitch all lps}

ml <- list("hyp"=dge1_l,
  "amy"=dge2_l,
  "hip"=dge3_l,
  "pag"=dge4_l,
  "ni"=dge5_l)

m6 <- mitch_import(ml, DEtype="deseq2",geneTable=gt)
head(m6)

mres6 <- mitch_calc(m6, genesets, priority="effect")

head(mres6$enrichment_result,20) %>%
  kbl(caption = "Top gene pathway differences in all tissues caused by LPS") %>%
  kable_paper("hover", full_width = F)
m6_top <- subset(mres6$enrichment_result,p.adjustMANOVA<0.05)
m6_up <- subset(m6_top,s.dist>0)$set
m6_dn <- subset(m6_top,s.dist<0)$set
mitch_report(mres6,outfile="mitch6.html",overwrite=TRUE)
write.table(mres6$enrichment_result,file="mitch6.tsv",quote=FALSE,sep="\t",row.names=FALSE)

m6_top_up <- head(subset(m6_top,s.dist>0),10)[,"s.dist"]
names(m6_top_up) <- head(subset(m6_top,s.dist>0),10)[,"set"]
m6_top_dn <- head(subset(m6_top,s.dist<0),10)[,"s.dist"]
names(m6_top_dn) <- head(subset(m6_top,s.dist<0),10)[,"set"]
m6_top_updn <- c(m6_top_up,m6_top_dn)
m6_top_updn <- m6_top_updn[order(m6_top_updn)]

# heatmap
mr6 <- head(subset(mres6$enrichment_result,p.adjustMANOVA<0.05),30)
mr6 <- as.matrix(mr6[,4:8])
rownames(mr6) <- head(mres6$enrichment_result,30)$set

colfunc <- colorRampPalette(c("blue", "white", "red"))

heatmap.2(mr6,trace="none",col=colfunc(25),scale="none", margins = c(10,21), cexRow=0.7,
  main="Top ranked pathways LPS all tissues" , cexCol=0.9 )

pdf("plot38_mitch6_heatmap01.pdf")
heatmap.2(mr6,trace="none",col=colfunc(25),scale="none", margins = c(10,21), cexRow=0.7,
  main="Top ranked pathways LPS all tissues" , cexCol=0.9 )
dev.off()

```

##  Mitch pathway analysis - OVA all tissues

```{r,mitch all ova}

ml <- list("hyp"=dge1_o,
  "amy"=dge2_o,
  "hip"=dge3_o,
  "pag"=dge4_o,
  "ni"=dge5_o)

m7 <- mitch_import(ml, DEtype="deseq2",geneTable=gt)
head(m7)

mres7 <- mitch_calc(m7, genesets, priority="effect")

head(mres7$enrichment_result,20) %>%
  kbl(caption = "Top gene pathway differences in all tissues caused by OVA") %>%
  kable_paper("hover", full_width = F)
m7_top <- subset(mres7$enrichment_result,p.adjustMANOVA<0.05)
m7_up <- subset(m7_top,s.dist>0)$set
m7_dn <- subset(m7_top,s.dist<0)$set
mitch_report(mres7,outfile="mitch7.html",overwrite=TRUE)
write.table(mres7$enrichment_result,file="mitch7.tsv",quote=FALSE,sep="\t",row.names=FALSE)

m7_top_up <- head(subset(m7_top,s.dist>0),10)[,"s.dist"]
names(m7_top_up) <- head(subset(m7_top,s.dist>0),10)[,"set"]
m7_top_dn <- head(subset(m7_top,s.dist<0),10)[,"s.dist"]
names(m7_top_dn) <- head(subset(m7_top,s.dist<0),10)[,"set"]
m7_top_updn <- c(m7_top_up,m7_top_dn)
m7_top_updn <- m7_top_updn[order(m7_top_updn)]

# heatmap
mr7 <- head(subset(mres7$enrichment_result,p.adjustMANOVA<0.05),30)
mr7 <- as.matrix(mr7[,4:8])
rownames(mr7) <- head(mres7$enrichment_result,30)$set

colfunc <- colorRampPalette(c("blue", "white", "red"))

heatmap.2(mr7,trace="none",col=colfunc(25),scale="none", margins = c(10,21), cexRow=0.7,
  main="Top ranked pathways OVA all tissues" , cexCol=0.9 )

pdf("plot39_mitch7_heatmap01.pdf")
heatmap.2(mr7,trace="none",col=colfunc(25),scale="none", margins = c(10,21), cexRow=0.7,
  main="Top ranked pathways OVA all tissues" , cexCol=0.9 )
dev.off()

```

## Conclusion

There was some variability among samples in the hypothalamus, in particular some OVA samples could be classified as outliers
(EA9-1 and EA3-1).
Further investigation would be required to understand the origin of this variability.
LPS resulted in the differential expression of just 30 genes in the hypothalamus.
OVA was variable, so no significant genes were identified.
Analysis with mitch identified some interesting pathways as seen in the mitch heatmap (see the mitch reports for details).
The mitch software can perform multi-contrast pathway analysis and will be important to contrast the effect of the treatments
in different tissues.

## References

Bibliography

1.      Babraham bioinformatics - FastQC A quality control tool for high throughput sequence data. Babraham.ac.uk, https://www.bioinformatics.babraham.ac.uk/projects/fastqc/ (accessed February 23, 2022).

2.      Frankish A, Diekhans M, Jungreis I, et al. GENCODE 2021. Nucleic Acids Res 2021; 49: D916–D923.

3.      Jiang H, Lei R, Ding S-W, et al. Skewer: a fast and accurate adapter trimmer for next-generation sequencing paired-end reads. BMC Bioinformatics 2014; 15: 182.

4.      Bray NL, Pimentel H, Melsted P, et al. Near-optimal probabilistic RNA-seq quantification. Nat Biotechnol 2016; 34: 525–527.

5.      Ewels P, Magnusson M, Lundin S, et al. MultiQC: summarize analysis results for multiple tools and samples in a single report. Bioinformatics 2016; 32: 3047–3048.

6.      Love MI, Huber W, Anders S. Moderated estimation of fold change and dispersion for RNA-seq data with DESeq2. Genome Biol 2014; 15: 550.

7.      Liberzon A, Birger C, Thorvaldsdóttir H, et al. The Molecular Signatures Database (MSigDB) hallmark gene set collection. Cell Syst 2015; 1: 417–425.

8.      Jassal B, Matthews L, Viteri G, et al. The reactome pathway knowledgebase. Nucleic Acids Res 2020; 48: D498–D503.

9.      Dolgalev I. MSigDB Gene Sets for Multiple Organisms in a Tidy Data Format [R package msigdbr version 7.4.1], https://cran.r-project.org/web/packages/msigdbr/index.html (2021, accessed February 23, 2022).

10.     Kaspi A, Ziemann M. Mitch: Multi-contrast pathway enrichment for multi-omics and single-cell profiling data. BMC Genomics 2020; 21: 447.

## Session information

For reproducibility.

```{r,sessioninfo}

sessionInfo()

```
